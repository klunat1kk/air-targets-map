<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Карта Повітряних Цілей - Розширена версія</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" 
      crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" 
      crossorigin="anonymous"/>
    <link rel="stylesheet" href="frontend/css/fontawesome.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="frontend/css/leaflet.contextmenu.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
            crossorigin="anonymous"></script>
    <script src="frontend/js/leaflet.contextmenu.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0c0e2a 0%, #1e2142 100%);
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .header {
            background: linear-gradient(90deg, #2d3436 0%, #2c3e50 100%);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid #00cec9;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 20px;
            font-weight: bold;
            color: #00cec9;
            text-shadow: 0 0 10px rgba(0, 206, 201, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 30%;
        }

        .header h1 i {
            margin-right: 8px;
        }

        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        #searchInput {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 2px solid #34495e;
            border-radius: 25px;
            background: #2d3436;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #searchInput:focus {
            outline: none;
            border-color: #00cec9;
            box-shadow: 0 0 10px rgba(0, 206, 201, 0.5);
        }

        .search-btn {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: #00cec9;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2d3436;
            border: 2px solid #34495e;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #34495e;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background: #34495e;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .header-controls {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .header-btn {
            background: linear-gradient(90deg, #0984e3 0%, #00cec9 100%);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            white-space: nowrap;
        }

        .header-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 206, 201, 0.4);
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
        }

        #map {
            flex: 1;
            z-index: 1;
            position: relative;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            z-index: 999;
            pointer-events: none;
        }

        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(0, 206, 201, 0.8);
        }

        .crosshair::before {
            width: 2px;
            height: 40px;
            left: 50%;
            transform: translateX(-50%);
        }

        .crosshair::after {
            width: 40px;
            height: 2px;
            top: 50%;
            transform: translateY(-50%);
        }

        .map-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(44, 62, 80, 0.9);
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #00cec9;
        }

        .map-switcher select {
            background: #2d3436;
            color: white;
            border: 1px solid #34495e;
            border-radius: 3px;
            padding: 5px;
        }

        /* Новая улучшенная панель с вкладками */
        .panel {
            width: 100%;
            height: 350px;
            background: rgba(30, 33, 66, 0.95);
            overflow: hidden;
            transition: all 0.3s ease;
            border-top: 2px solid #00cec9;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .panel.collapsed {
            height: 50px;
        }

        .panel-tabs {
            display: flex;
            background: rgba(44, 62, 80, 0.8);
            border-bottom: 1px solid #34495e;
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-right: 1px solid #34495e;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .panel-tab:last-child {
            border-right: none;
        }

        .panel-tab.active {
            background: linear-gradient(90deg, #0984e3 0%, #00cec9 100%);
            color: white;
        }

        .panel-tab:hover:not(.active) {
            background: rgba(52, 73, 94, 0.8);
        }

        .panel-content {
            height: calc(100% - 50px);
            overflow-y: auto;
            padding: 15px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .panel-section {
            margin-bottom: 15px;
            background: rgba(44, 62, 80, 0.6);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #34495e;
        }

        .panel-section h3 {
            color: #00cec9;
            margin-bottom: 12px;
            font-size: 16px;
            border-bottom: 2px solid #00cec9;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #dfe6e9;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #34495e;
            border-radius: 5px;
            background: #2d3436;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00cec9;
            box-shadow: 0 0 10px rgba(0, 206, 201, 0.5);
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: 2px solid #34495e;
            border-radius: 5px;
            cursor: pointer;
        }

        .range-input {
            width: 100%;
            margin: 10px 0;
        }

        .btn {
            background: linear-gradient(90deg, #0984e3 0%, #00cec9 100%);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 5px;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 206, 201, 0.4);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            width: auto;
            margin: 2px;
        }

        .btn-danger {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-secondary {
            background: linear-gradient(90deg, #7f8c8d 0%, #636e72 100%);
        }

        .btn-success {
            background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
        }

        .btn-margin {
            margin-top: 10px;
        }

        .targets-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .target-item {
            background: rgba(52, 73, 94, 0.6);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid #00cec9;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .target-item:hover {
            background: rgba(52, 73, 94, 0.9);
            transform: translateX(5px);
        }

        .target-item h4 {
            color: #00cec9;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .target-item p {
            color: #dfe6e9;
            font-size: 12px;
            margin: 2px 0;
        }

        .target-item .target-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .target-item .target-actions button {
            flex: 1;
            padding: 4px;
            font-size: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-card {
            background: rgba(52, 73, 94, 0.6);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #34495e;
        }

        .stat-card h4 {
            color: #00cec9;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #dfe6e9;
            font-size: 11px;
        }

        .status-bar {
            background: rgba(44, 62, 80, 0.9);
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #00cec9;
            font-size: 12px;
            flex-shrink: 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00b894;
            animation: pulse 2s infinite;
        }

        .offline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #d63031;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2d3436 0%, #2c3e50 100%);
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 2px solid #00cec9;
            position: relative;
        }

        .modal-content h3 {
            color: #00cec9;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            font-size: 14px;
            font-weight: bold;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #00cec9;
            font-size: 20px;
            cursor: pointer;
        }

        .course-notification {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90d, #0984e3 0%, #00cec9 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0, 206, 201, 0.5);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        /* Стили для траекторий */
        .trajectory-settings {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .pattern-btn {
            padding: 8px;
            border: 2px solid #34495e;
            background: rgba(52, 73, 94, 0.6);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 12px;
        }

        .pattern-btn:hover {
            border-color: #00cec9;
            background: rgba(0, 206, 201, 0.2);
        }

        .pattern-btn.active {
            border-color: #00cec9;
            background: linear-gradient(90deg, #0984e3 0%, #00cec9 100%);
        }

        /* Улучшенные стили маркеров */
        .png-icon-marker {
            background: transparent !important;
            border: none !important;
        }

        .rotatable-png-icon {
            width: 40px;
            height: 40px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: transform 0.5s ease;
            transform-origin: center;
        }

        .marker-cluster {
            background: rgba(231, 76, 60, 0.8);
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.8);
        }

        .marker-cluster-small {
            width: 40px;
            height: 40px;
            font-size: 14px;
        }

        .marker-cluster-medium {
            width: 50px;
            height: 50px;
            font-size: 16px;
        }

        .marker-cluster-large {
            width: 60px;
            height: 60px;
            font-size: 18px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 18px;
                max-width: 30%;
            }
            
            .search-container {
                max-width: 250px;
                margin: 0 10px;
            }
            
            .header-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .panel {
                height: 300px;
            }
            
            .panel.collapsed {
                height: 45px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }

            .panel-tabs {
                flex-wrap: wrap;
            }

            .panel-tab {
                min-width: 25%;
                font-size: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 10px;
                flex-wrap: wrap;
            }
            
            .header h1 {
                font-size: 16px;
                max-width: 100%;
                margin-bottom: 10px;
                order: 1;
            }
            
            .search-container {
                order: 3;
                max-width: 100%;
                margin: 10px 0 0 0;
            }
            
            .header-controls {
                order: 2;
                width: 100%;
                justify-content: space-between;
            }
            
            .header-btn {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .header-btn span {
                display: none;
            }

            .form-row {
                flex-direction: column;
            }

            .trajectory-settings {
                grid-template-columns: 1fr;
            }

            .pattern-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Анимации */
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .target-item {
            animation: slideIn 0.3s ease;
        }

        .notification {
            animation: fadeIn 0.3s ease;
        }

        /* Улучшенные стили для всплывающих окон */
        .leaflet-popup-content-wrapper {
            background: linear-gradient(135deg, #2d3436 0%, #2c3e50 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,.4);
        }

        .leaflet-popup-content {
            margin: 12px 16px;
            font-size: 14px;
        }

        .target-info-window h4 {
            color: #00cec9;
            margin-bottom: 8px;
            border-bottom: 1px solid #00cec9;
            padding-bottom: 4px;
        }

        .target-info-window p {
            margin: 4px 0;
            color: #dfe6e9;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .action-button {
            flex: 1;
            padding: 6px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .delete-btn {
            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .course-btn {
            background: linear-gradient(90deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Улучшенный скроллбар */
        .panel-content::-webkit-scrollbar,
        .targets-list::-webkit-scrollbar {
            width: 8px;
        }

        .panel-content::-webkit-scrollbar-track,
        .targets-list::-webkit-scrollbar-track {
            background: rgba(52, 73, 94, 0.3);
            border-radius: 4px;
        }

        .panel-content::-webkit-scrollbar-thumb,
        .targets-list::-webkit-scrollbar-thumb {
            background: rgba(0, 206, 201, 0.6);
            border-radius: 4px;
        }

        .panel-content::-webkit-scrollbar-thumb:hover,
        .targets-list::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 206, 201, 0.8);
        }
    </style>
</head>
<body>
    <!-- Модальное окно с предупреждением -->
    <div id="warningModal" class="modal" style="display: block;">
        <div class="modal-content" style="max-width: 600px;">
            <h3><i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i> УВАГА</h3>
            <div style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
                <p style="color: #dfe6e9; line-height: 1.6; font-size: 14px;">
                    <strong>Дані беруться з відкритих джерел (Telegram тощо) та можуть містити похибки.</strong><br><br>
                    
                    • Всі цілі додаються на карту вручну<br>
                    • Сервіс не є офіційною системою оповіщення<br>
                    • Не замінює сигналів Повітряної тривоги<br>
                    • Не використовуйте інформацію для коригування вогню<br>
                    • Не розкривайте позиції Сил Оборони<br><br>
                    
                    <strong>Завжди дотримуйтесь вказівок офіційних органів!</strong><br><br>
                    
                    <strong style="color: #00cec9;">🚀 Нові функції розширеної версії:</strong><br>
                    • Покращені налаштування траєкторій<br>
                    • Нові паттерни руху цілей<br>
                    • Розширена статистика<br>
                    • Групи цілей та категорії<br>
                    • Більш гнучкі налаштування відображення
                </p>
            </div>
            <div class="modal-buttons">
                <button onclick="closeWarningModal()" class="btn btn-success">Зрозуміло</button>
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <div class="header">
            <h1><i class="fas fa-crosshairs"></i><span>Карта Повітряних Цілей - Розширена</span></h1>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Пошук міста або села...">
                    <button class="search-btn" onclick="performSearch()">
                        <i class="fas fa-search"></i>
                    </button>
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>

            <div class="header-controls">
                <button class="header-btn toggle-panel-btn" onclick="togglePanel()">
                    <i class="fas fa-eye-slash"></i><span>Панель</span>
                </button>
                <button class="header-btn" onclick="toggleFullscreen()">
                    <i class="fas fa-expand"></i><span>Повний екран</span>
                </button>
                <button class="header-btn login-btn" onclick="showLoginModal()">
                    <i class="fas fa-user"></i><span>Увійти</span>
                </button>
                <button class="header-btn logout-btn" onclick="logout()" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i><span>Вийти</span>
                </button>
            </div>
        </div>

        <div class="main-content">
            <div id="map">
                <div class="crosshair"></div>
                <div class="map-switcher">
                    <select id="mapStyleSelector" onchange="changeMapStyle()">
                        <option value="dark">Темна карта</option>
                        <option value="standard">Стандартна</option>
                        <option value="satellite">Супутник</option>
                    </select>
                </div>
            </div>
            
            <div class="panel" id="sidePanel">
                <div class="panel-tabs">
                    <div class="panel-tab active" data-tab="targets">
                        <i class="fas fa-bullseye"></i>
                        <span>Цілі</span>
                    </div>
                    <div class="panel-tab" data-tab="trajectories">
                        <i class="fas fa-route"></i>
                        <span>Траєкторії</span>
                    </div>
                    <div class="panel-tab" data-tab="statistics">
                        <i class="fas fa-chart-line"></i>
                        <span>Статистика</span>
                    </div>
                    <div class="panel-tab" data-tab="settings">
                        <i class="fas fa-cogs"></i>
                        <span>Налаштування</span>
                    </div>
                </div>
                
                <div class="panel-content">
                    <!-- Вкладка "Цілі" -->
                    <div id="targets-tab" class="tab-content active">
                        <div class="panel-section">
                            <h3><i class="fas fa-plus-circle"></i>Додати ціль</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="targetName">Назва цілі:</label>
                                    <input type="text" id="targetName" placeholder="Введіть назву цілі" value="Ціль-1">
                                </div>
                                <div class="form-group">
                                    <label for="targetType">Тип цілі:</label>
                                    <select id="targetType">
                                        <option value="дрон">Дрон</option>
                                        <option value="ракета">Ракета</option>
                                        <option value="винищувач">Винищувач</option>
                                        <option value="бомба">Бомба</option>
                                        <option value="корабль">Корабель</option>
                                        <option value="вертоліт">Вертоліт</option>
                                        <option value="пускова установка">Пускова установка</option>
                                        <option value="група бпла">Група БпЛА</option>
                                        <option value="розвідник">Розвідник</option>
                                        <option value="невідома ціль">Невідома ціль</option>
                                        <option value="балістична ракета">Балістична ракета</option>
                                        <option value="крилата ракета">Крилата ракета</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="targetSpeed">Швидкість (км/год):</label>
                                    <input type="number" id="targetSpeed" value="150" min="0" max="30000">
                                </div>
                                <div class="form-group">
                                    <label for="targetCourse">Курс (0-360°):</label>
                                    <input type="number" id="targetCourse" value="0" min="0" max="360">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="targetGroup">Група:</label>
                                    <select id="targetGroup">
                                        <option value="default">Основна</option>
                                        <option value="air">Повітряні</option>
                                        <option value="ground">Наземні</option>
                                        <option value="naval">Морські</option>
                                        <option value="custom">Користувацька</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="targetColor">Колір траєкторії:</label>
                                    <input type="color" id="targetColor" class="color-picker" value="#ff0000">
                                </div>
                            </div>
                            <button class="btn" onclick="addTargetAtCenter()">
                                <i class="fas fa-plus"></i>Додати в центр
                            </button>
                        </div>

                        <div class="panel-section">
                            <h3><i class="fas fa-list"></i>Список цілей</h3>
                            <div class="targets-list" id="targetsList"></div>
                        </div>
                    </div>

                    <!-- Вкладка "Траєкторії" -->
                    <div id="trajectories-tab" class="tab-content">
                        <div class="panel-section">
                            <h3><i class="fas fa-route"></i>Налаштування траєкторій</h3>
                            <div class="trajectory-settings">
                                <div class="form-group">
                                    <label for="trajectoryOpacity">Прозорість:</label>
                                    <input type="range" id="trajectoryOpacity" min="0.1" max="1" step="0.1" value="0.7" class="range-input">
                                    <span id="opacityValue">70%</span>
                                </div>
                                <div class="form-group">
                                    <label for="trajectoryWidth">Товщина лінії:</label>
                                    <input type="range" id="trajectoryWidth" min="1" max="10" value="3" class="range-input">
                                    <span id="widthValue">3px</span>
                                </div>
                                <div class="form-group">
                                    <label for="trajectoryLength">Довжина траєкторії:</label>
                                    <input type="range" id="trajectoryLength" min="5" max="100" value="20" class="range-input">
                                    <span id="lengthValue">20 точок</span>
                                </div>
                                <div class="form-group">
                                    <label for="animationSpeed">Швидкість анімації:</label>
                                    <input type="range" id="animationSpeed" min="0.1" max="5" step="0.1" value="1" class="range-input">
                                    <span id="speedValue">1x</span>
                                </div>
                            </div>
                            
                            <h4 style="color: #00cec9; margin: 15px 0 10px 0;">Паттерни руху:</h4>
                            <div class="pattern-grid">
                                <div class="pattern-btn active" data-pattern="linear" onclick="setMovementPattern('linear')">
                                    <i class="fas fa-long-arrow-alt-right"></i><br>Лінійний
                                </div>
                                <div class="pattern-btn" data-pattern="zigzag" onclick="setMovementPattern('zigzag')">
                                    <i class="fas fa-chart-line"></i><br>Зигзаг
                                </div>
                                <div class="pattern-btn" data-pattern="spiral" onclick="setMovementPattern('spiral')">
                                    <i class="fas fa-sync-alt"></i><br>Спіраль
                                </div>
                                <div class="pattern-btn" data-pattern="circle" onclick="setMovementPattern('circle')">
                                    <i class="fas fa-circle-notch"></i><br>Коло
                                </div>
                                <div class="pattern-btn" data-pattern="patrol" onclick="setMovementPattern('patrol')">
                                    <i class="fas fa-exchange-alt"></i><br>Патруль
                                </div>
                                <div class="pattern-btn" data-pattern="random" onclick="setMovementPattern('random')">
                                    <i class="fas fa-question"></i><br>Випадковий
                                </div>
                            </div>
                            
                            <button class="btn btn-margin" onclick="toggleTrajectories()">
                                <i class="fas fa-eye"></i><span id="trajectoryToggleText">Приховати траєкторії</span>
                            </button>
                            <button class="btn btn-secondary btn-margin" onclick="clearAllTrajectories()">
                                <i class="fas fa-eraser"></i>Очистити траєкторії
                            </button>
                        </div>
                    </div>

                    <!-- Вкладка "Статистика" -->
                    <div id="statistics-tab" class="tab-content">
                        <div class="panel-section">
                            <h3><i class="fas fa-chart-bar"></i>Загальна статистика</h3>
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <h4 id="totalTargets">0</h4>
                                    <p>Всього цілей</p>
                                </div>
                                <div class="stat-card">
                                    <h4 id="activeTargets">0</h4>
                                    <p>Активних</p>
                                </div>
                                <div class="stat-card">
                                    <h4 id="maxSpeed">0</h4>
                                    <p>Макс. швидкість</p>
                                </div>
                                <div class="stat-card">
                                    <h4 id="avgSpeed">0</h4>
                                    <p>Серед. швидкість</p>
                                </div>
                                <div class="stat-card">
                                    <h4 id="totalDistance">0</h4>
                                    <p>Загальна відстань</p>
                                </div>
                                <div class="stat-card">
                                    <h4 id="onlineTime">00:00</h4>
                                    <p>Час роботи</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="panel-section">
                            <h3><i class="fas fa-pie-chart"></i>Розподіл по типам</h3>
                            <canvas id="targetTypesChart" width="300" height="150"></canvas>
                        </div>
                        
                        <div class="panel-section">
                            <h3><i class="fas fa-layer-group"></i>Статистика по групах</h3>
                            <div id="groupStats" class="stats-grid">
                                <!-- Динамічно заповнюється -->
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка "Налаштування" -->
                    <div id="settings-tab" class="tab-content">
                        <div class="panel-section">
                            <h3><i class="fas fa-display"></i>Відображення</h3>
                            <button class="btn btn-small" onclick="toggleClustering()" id="toggleClusterBtn">
                                <i class="fas fa-object-group"></i>Кластеризація: Увімкнена
                            </button>
                            <button class="btn btn-small" onclick="toggleArrowMode()" id="toggleArrowBtn">
                                <i class="fas fa-draw-polygon"></i>Режим стрілок
                            </button>
                            <button class="btn btn-small" onclick="toggleTimestamps()">
                                <i class="fas fa-clock"></i>Часові мітки
                            </button>
                            <button class="btn btn-small" onclick="toggleGrid()">
                                <i class="fas fa-border-all"></i>Сітка координат
                            </button>
                        </div>
                        
                        <div class="panel-section">
                            <h3><i class="fas fa-tachometer-alt"></i>Продуктивність</h3>
                            <div class="form-group">
                                <label for="updateInterval">Інтервал оновлення (мс):</label>
                                <input type="range" id="updateInterval" min="50" max="1000" step="50" value="100" class="range-input">
                                <span id="intervalValue">100ms</span>
                            </div>
                            <div class="form-group">
                                <label for="maxTrajectoryPoints">Макс. точок траєкторії:</label>
                                <input type="range" id="maxTrajectoryPoints" min="10" max="200" step="10" value="50" class="range-input">
                                <span id="maxPointsValue">50 точок</span>
                            </div>
                            <button class="btn btn-small" onclick="togglePerformanceMode()">
                                <i class="fas fa-bolt"></i>Режим продуктивності
                            </button>
                        </div>
                        
                        <div class="panel-section">
                            <h3><i class="fas fa-database"></i>Дані</h3>
                            <button class="btn btn-secondary btn-small" onclick="exportTargets()">
                                <i class="fas fa-download"></i>Експорт JSON
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportCSV()">
                                <i class="fas fa-file-csv"></i>Експорт CSV
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="importTargets()">
                                <i class="fas fa-upload"></i>Імпорт
                            </button>
                            <button class="btn btn-danger btn-small" onclick="clearAllTargets()">
                                <i class="fas fa-trash"></i>Очистити всі цілі
                            </button>
                            <button class="btn btn-danger btn-small" onclick="clearLocalStorage()">
                                <i class="fas fa-trash-alt"></i>Очистити сховище
                            </button>
                        </div>
                        
                        <div class="panel-section">
                            <h3><i class="fas fa-wifi"></i>Підключення</h3>
                            <button class="btn btn-small" onclick="checkConnection()">
                                <i class="fas fa-wifi"></i>Перевірити підключення
                            </button>
                            <button class="btn btn-small" onclick="reconnectFirebase()">
                                <i class="fas fa-sync-alt"></i>Переподключитися
                            </button>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="autoSync" checked> Автоматична синхронізація
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div id="statusDot" class="offline-dot"></div>
                <span id="statusText">Офлайн</span>
            </div>
            <div id="performanceInfo">FPS: <span id="fpsCounter">60</span></div>
            <div id="onlineUsers">Онлайн: 0</div>
            <div id="lastUpdate">Оновлено: --:--:--</div>
        </div>
    </div>

    <!-- Модальні вікна -->
    
    <!-- Модальне вікно логіну -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeLoginModal()">&times;</button>
            <h3><i class="fas fa-user-shield"></i>Вхід для адміністратора</h3>
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" placeholder="Введіть email">
            </div>
            <div class="form-group">
                <label for="loginPassword">Пароль:</label>
                <input type="password" id="loginPassword" placeholder="Введіть пароль">
            </div>
            <div class="modal-buttons">
                <button onclick="attemptLogin()" class="btn">Увійти</button>
                <button onclick="closeLoginModal()" class="btn btn-danger">Скасувати</button>
            </div>
        </div>
    </div>

    <!-- Модальне вікно редагування -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeEditModal()">&times;</button>
            <h3><i class="fas fa-edit"></i>Редагувати ціль</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="editName">Назва цілі:</label>
                    <input type="text" id="editName">
                </div>
                <div class="form-group">
                    <label for="editType">Тип цілі:</label>
                    <select id="editType">
                        <option value="дрон">Дрон</option>
                        <option value="ракета">Ракета</option>
                        <option value="винищувач">Винищувач</option>
                        <option value="бомба">Бомба</option>
                        <option value="корабль">Корабель</option>
                        <option value="вертоліт">Вертоліт</option>
                        <option value="пускова установка">Пускова установка</option>
                        <option value="група бпла">Група БпЛА</option>
                        <option value="розвідник">Розвідник</option>
                        <option value="невідома ціль">Невідома ціль</option>
                        <option value="балістична ракета">Балістична ракета</option>
                        <option value="крилата ракета">Крилата ракета</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editSpeed">Швидкість (км/год):</label>
                    <input type="number" id="editSpeed">
                </div>
                <div class="form-group">
                    <label for="editCourse">Курс (0-360°):</label>
                    <input type="number" id="editCourse" min="0" max="360">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="editGroup">Група:</label>
                    <select id="editGroup">
                        <option value="default">Основна</option>
                        <option value="air">Повітряні</option>
                        <option value="ground">Наземні</option>
                        <option value="naval">Морські</option>
                        <option value="custom">Користувацька</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editColor">Колір траєкторії:</label>
                    <input type="color" id="editColor" class="color-picker">
                </div>
            </div>
            <div class="modal-buttons">
                <button onclick="saveTargetEdit()" class="btn">Зберегти</button>
                <button onclick="closeEditModal()" class="btn btn-danger">Скасувати</button>
            </div>
        </div>
    </div>

    <!-- Модальне вікно вибору курсу -->
    <div id="courseSelectionModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="cancelCourseSelection()">&times;</button>
            <h3><i class="fas fa-route"></i>Вибір курсу</h3>
            <p>Клацніть по карті, щоб встановити напрямок руху цілі</p>
            <div class="modal-buttons">
                <button onclick="confirmCourseSelection()" class="btn">Підтвердити</button>
                <button onclick="cancelCourseSelection()" class="btn btn-danger">Скасувати</button>
            </div>
        </div>
    </div>

    <input type="file" id="importFile" style="display: none;" accept=".json,.csv">

    <script>
        // Глобальные переменные
        let map;
        let targets = [];
        let markers = {};
        let polylines = {};
        let targetHistory = {};
        let showTrajectories = true;
        let isPanelExpanded = true;
        let isCourseSelectionMode = false;
        let selectedTargetForCourse = null;
        let autoSaveInterval = null;
        let isAdmin = false;
        let currentEditTargetId = null;
        let saveTimeout = null;
        let lastUpdateTime = Date.now();
        let animationFrameId = null;
        let isAddTargetMode = false;
        let popupOpenTargetId = null;
        let deletedTargets = new Set();
        let markerCluster;
        let lastStatsUpdate = Date.now();
        let pausedTargets = new Set();
        let isOnline = false;
        let isSyncing = false;
        let lastSyncTime = Date.now();
        let syncInterval = null;
        let userSessionId = Math.random().toString(36).substring(2, 11);
        let lastSyncTargets = '';
        let lastSyncDeleted = '';
        let locallyModifiedTargets = new Set();
        let modificationTimeouts = {};

        // Переменные для поиска
        let searchMarker = null;
        let searchResults = [];
        let searchTimeout = null;

        // Переменные для функционала стрелок и кластеризации
        let isClusteringEnabled = true;
        let arrowMode = false;
        let tempArrowLine = null;
        let tempArrowStartLatLng = null;
        let allArrows = L.layerGroup();
        let individualTargets = L.layerGroup();

        // Текущий стиль карты
        let currentMapStyle = 'dark';

        // Слои карты
        let baseLayers = {
            'dark': null,
            'standard': null,
            'satellite': null
        };

        // Новые переменные для расширенной функциональности
        let currentTab = 'targets';
        let currentMovementPattern = 'linear';
        let trajectorySettings = {
            opacity: 0.7,
            width: 3,
            length: 20,
            animationSpeed: 1.0
        };
        let performanceMode = false;
        let showTimestamps = false;
        let showGrid = false;
        let updateInterval = 100;
        let maxTrajectoryPoints = 50;
        let startTime = Date.now();
        let frameCount = 0;
        let lastFPSUpdate = Date.now();
        let currentFPS = 60;
        let targetChart = null;

        // Группы целей
        const targetGroups = {
            'default': { name: 'Основна', color: '#00cec9' },
            'air': { name: 'Повітряні', color: '#0984e3' },
            'ground': { name: 'Наземні', color: '#27ae60' },
            'naval': { name: 'Морські', color: '#2980b9' },
            'custom': { name: 'Користувацька', color: '#9b59b6' }
        };

        // Конфигурация иконок для разных стилей карты (расширенная)
        const iconConfig = {
            'dark': {
                'дрон': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNmZjAwMDAiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAxLjVMMTYuNSA2SDE5LjVMMjIuNSA5VjEwLjVIMjBWMTRINFYxMC41SDEuNVY5TDQuNSA2SDcuNUwxMiAxLjVaIi8+CjwvZz4KPC9zdmc+",
                'ракета': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNlNzRjM2MiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyTDE2IDZWMTBIMTNWMTZIMTFWMTBIOFY2TDEyIDJaIi8+CjwvZz4KPC9zdmc+",
                'винищувач': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNmMzljMTIiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yIDEyTDEwIDhWNEwxMiAyTDE0IDRWOEwyMiAxMlYxNEgyMFYyMEgxNlYxOEg4VjIwSDRWMTRIMloiLz4KPC9nPgo8L3N2Zz4=",
                'балістична ракета': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNkNjMwMzEiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAxTDE0IDNWNkgxNkwyMCAxMFYxNEgxNlYyMEgxNFYxNkgxMFYxNEg4VjEwTDEyIDZWM0wxMiAxWiIvPgo8L2c+Cjwvc3ZnPg=="
            },
            'standard': {
                'дрон': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNmZjAwMDAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDEuNUwxNi41IDZIMTkuNUwyMi41IDlWMTAuNUgyMFYxNEg0VjEwLjVIMS41VjlMNC41IDZINy41TDEyIDEuNVoiLz4KPC9nPgo8L3N2Zz4=",
                'ракета': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNlNzRjM2MiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJMMTYgNlYxMEgxM1YxNkgxMVYxMEg4VjZMMTIgMloiLz4KPC9nPgo8L3N2Zz4=",
                'винищувач': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNmMzljMTIiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTIgMTJMMTAgOFY0TDEyIDJMMTQgNFY4TDIyIDEyVjE0SDIwVjIwSDE2VjE4SDhWMjBINFYxNEgyWiIvPgo8L2c+Cjwvc3ZnPg==",
                'балістична ракета': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNkNjMwMzEiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDFMMTQgM1Y2SDE2TDIwIDEwVjE0SDE2VjIwSDE0VjE2SDEwVjE0SDhWMTBMMTIgNlYzTDEyIDFaIi8+CjwvZz4KPC9zdmc+"
            },
            'satellite': {
                'дрон': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNmZjAwMDAiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMyIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDEuNUwxNi41IDZIMTkuNUwyMi41IDlWMTAuNUgyMFYxNEg0VjEwLjVIMS41VjlMNC41IDZINy41TDEyIDEuNVoiLz4KPC9nPgo8L3N2Zz4=",
                'ракета': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNlNzRjM2MiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMyIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDJMMTYgNlYxMEgxM1YxNkgxMVYxMEg4VjZMMTIgMloiLz4KPC9nPgo8L3N2Zz4=",
                'винищувач': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNmMzljMTIiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMyIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTIgMTJMMTAgOFY0TDEyIDJMMTQgNFY4TDIyIDEyVjE0SDIwVjIwSDE2VjE4SDhWMjBINFYxNEgyWiIvPgo8L2c+Cjwvc3ZnPg==",
                'балістична ракета': "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMTgiIGZpbGw9IiNkNjMwMzEiIHN0cm9rZT0iYmxhY2siIHN0cm9rZS13aWR0aD0iMyIvPgo8c3ZnIHg9IjEwIiB5PSIxMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IndoaXRlIj4KPHBhdGggZD0iTTEyIDFMMTQgM1Y2SDE2TDIwIDEwVjE0SDE2VjIwSDE0VjE2SDEwVjE0SDhWMTBMMTIgNlYzTDEyIDFaIi8+CjwvZz4KPC9zdmc+"
            }
        };

        // Fallback иконки для остальных типов
        const fallbackIcons = {
            'бомба': { color: '#e17055', icon: 'fas fa-bomb' },
            'корабль': { color: '#0984e3', icon: 'fas fa-ship' },
            'вертоліт': { color: '#00b894', icon: 'fas fa-helicopter' },
            'пускова установка': { color: '#6c5ce7', icon: 'fas fa-rocket' },
            'група бпла': { color: '#fd79a8', icon: 'fas fa-cubes' },
            'розвідник': { color: '#fdcb6e', icon: 'fas fa-search' },
            'невідома ціль': { color: '#636e72', icon: 'fas fa-question' },
            'крилата ракета': { color: '#e84393', icon: 'fas fa-space-shuttle' }
        };

        // База данных всех населенных пунктов Украины (сокращенная версия)
        const ukraineCities = [
            // Областные центры
            { name: "Київ", lat: 50.4501, lng: 30.5234, type: "столиця" },
            { name: "Харків", lat: 49.9935, lng: 36.2304, type: "обласний центр" },
            { name: "Одеса", lat: 46.4825, lng: 30.7233, type: "обласний центр" },
            { name: "Дніпро", lat: 48.4647, lng: 35.0462, type: "обласний центр" },
            { name: "Донецьк", lat: 48.0159, lng: 37.8029, type: "обласний центр" },
            { name: "Запоріжжя", lat: 47.8388, lng: 35.1396, type: "обласний центр" },
            { name: "Львів", lat: 49.8397, lng: 24.0297, type: "обласний центр" },
            { name: "Кривий Ріг", lat: 47.9105, lng: 33.3918, type: "місто" },
            { name: "Миколаїв", lat: 46.9750, lng: 31.9946, type: "обласний центр" },
            { name: "Маріуполь", lat: 47.0971, lng: 37.5434, type: "місто" },
            { name: "Луганськ", lat: 48.5740, lng: 39.3078, type: "обласний центр" },
            { name: "Вінниця", lat: 49.2331, lng: 28.4682, type: "обласний центр" },
            { name: "Херсон", lat: 46.6354, lng: 32.6169, type: "обласний центр" },
            { name: "Полтава", lat: 49.5883, lng: 34.5514, type: "обласний центр" },
            { name: "Чернігів", lat: 51.4982, lng: 31.2893, type: "обласний центр" },
            { name: "Черкаси", lat: 49.4444, lng: 32.0598, type: "обласний центр" },
            { name: "Житомир", lat: 50.2547, lng: 28.6587, type: "обласний центр" },
            { name: "Суми", lat: 50.9077, lng: 34.7981, type: "обласний центр" },
            { name: "Хмельницький", lat: 49.4229, lng: 26.9871, type: "обласний центр" },
            { name: "Чернівці", lat: 48.2917, lng: 25.9352, type: "обласний центр" },
            { name: "Рівне", lat: 50.6199, lng: 26.2516, type: "обласний центр" },
            { name: "Івано-Франківськ", lat: 48.9226, lng: 24.7111, type: "обласний центр" },
            { name: "Тернопіль", lat: 49.5535, lng: 25.5948, type: "обласний центр" },
            { name: "Луцьк", lat: 50.7472, lng: 25.3254, type: "обласний центр" },
            { name: "Ужгород", lat: 48.6208, lng: 22.2879, type: "обласний центр" },
            // Крупные города
            { name: "Біла Церква", lat: 49.7956, lng: 30.1167, type: "місто" },
            { name: "Краматорськ", lat: 48.7382, lng: 37.5842, type: "місто" },
            { name: "Мелітополь", lat: 46.8480, lng: 35.3653, type: "місто" },
            { name: "Слов'янськ", lat: 48.8534, lng: 37.6053, type: "місто" },
            { name: "Бердянськ", lat: 46.7590, lng: 36.7884, type: "місто" },
            { name: "Нікополь", lat: 47.5672, lng: 34.3949, type: "місто" },
            { name: "Павлоград", lat: 48.5204, lng: 35.8706, type: "місто" },
            { name: "Умань", lat: 48.7500, lng: 30.2167, type: "місто" },
            { name: "Бровари", lat: 50.5113, lng: 30.7905, type: "місто" },
            { name: "Мукачево", lat: 48.4415, lng: 22.7136, type: "місто" },
            { name: "Бахмут", lat: 48.5956, lng: 38.0000, type: "місто" },
            { name: "Авдіївка", lat: 48.1333, lng: 37.7500, type: "місто" },
            { name: "Покровськ", lat: 48.2833, lng: 37.1833, type: "місто" },
            { name: "Куп'янськ", lat: 49.7167, lng: 37.6167, type: "місто" },
            { name: "Лиман", lat: 48.9833, lng: 37.8167, type: "місто" },
            { name: "Балаклія", lat: 49.4667, lng: 36.8667, type: "місто" },
            { name: "Ізюм", lat: 49.2167, lng: 37.2833, type: "місто" },
            // Російські міста біля кордону
            { name: "Ростов-на-Дону", lat: 47.2221, lng: 39.7203, type: "російське місто" },
            { name: "Белгород", lat: 50.5955, lng: 36.5873, type: "російське місто" },
            { name: "Курск", lat: 51.7304, lng: 36.1926, type: "російське місто" },
            { name: "Воронеж", lat: 51.6720, lng: 39.1843, type: "російське місто" },
            { name: "Брянск", lat: 53.2436, lng: 34.3634, type: "російське місто" }
        ];

        // ВАШІ НАЛАШТУВАННЯ FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCXB-klfdlwFb8QzbeqolqSghBpPrmFwio",
            authDomain: "air-tracking-site.firebaseapp.com",
            databaseURL: "https://air-tracking-site-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "air-tracking-site",
            storageBucket: "air-tracking-site.firebasestorage.app",
            messagingSenderId: "185790784262",
            appId: "1:185790784262:web:bc28d6942b6d9792b8b487",
            measurementId: "G-XW9Y6JKCPG"
        };

        // Типы целей с названиями
        const targetTypes = {
            'дрон': { name: "Дрон" },
            'ракета': { name: "Ракета" },
            'винищувач': { name: "Винищувач" },
            'бомба': { name: "Бомба" },
            'корабль': { name: "Корабель" },
            'вертоліт': { name: "Вертоліт" },
            'пускова установка': { name: "Пускова установка" },
            'група бпла': { name: "Група БпЛА" },
            'розвідник': { name: "Розвідник" },
            'невідома ціль': { name: "Невідома ціль" },
            'балістична ракета': { name: "Балістична ракета" },
            'крилата ракета': { name: "Крилата ракета" }
        };

        // =========================
        // ОСНОВНІ ФУНКЦІЇ ДОДАТКА
        // =========================

        // Закрыть предупреждение
        function closeWarningModal() {
            document.getElementById('warningModal').style.display = 'none';
            localStorage.setItem('warningShown', 'true');
        }

        // Инициализация приложения
        function initApp() {
            console.log("Ініціалізація розширеної версії додатка...");
            
            // Проверка загрузки библиотек
            if (typeof L === 'undefined') {
                console.error('Leaflet не завантажився');
                alert('Помилка: Бібліотека карт не завантажилась. Перевірте підключення до інтернету');
                return;
            }
            
            if (typeof firebase === 'undefined') {
                console.error('Firebase не завантажився');
                alert('Помилка: Firebase не завантажився. Деякі функції будуть обмежені');
            }
            
            try {
                initMap();
                loadTargetsFromLocalStorage();
                initFirebase();
                setupEventListeners();
                updateStats();
                updateStatus();
                startAutoSave();
                updateUIForUserRole();
                initializeRangeSliders();
                startAnimationLoop();
                
                // Показываем предупреждение только при первом посещении
                if (!localStorage.getItem('warningShown')) {
                    document.getElementById('warningModal').style.display = 'block';
                }
                
                console.log("Додаток успішно ініціалізовано");
            } catch (error) {
                console.error('Помилка ініціалізації:', error);
                alert('Помилка ініціалізації: ' + error.message);
            }
        }

        // Инициализация карты
        function initMap() {
            try {
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    throw new Error('Елемент карти не знайдено');
                }
                
                // Проверяем, не инициализирована ли карта уже
                if (map) {
                    map.remove();
                    map = null;
                    markers = {};
                    polylines = {};
                }
                
                // Очищаем контейнер карты
                mapElement.innerHTML = '<div class="crosshair"></div><div class="map-switcher"><select id="mapStyleSelector" onchange="changeMapStyle()"><option value="dark">Темна карта</option><option value="standard">Стандартна</option><option value="satellite">Супутник</option></select></div>';
                
                map = L.map('map').setView([50.4500, 30.5233], 6);

                // Базовые слои карты
                baseLayers.dark = L.tileLayer('https://api.maptiler.com/maps/basic-v2-dark/{z}/{x}/{y}.png?key=FwLDJ8CDh1JptvWufV7a', {
                    attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">© MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">© OpenStreetMap contributors</a>',
                    maxZoom: 19,
                    tileSize: 512,
                    zoomOffset: -1
                }).addTo(map);

                baseLayers.standard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                });

                const satelliteBase = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 19
                });

                const satelliteLabels = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    opacity: 0.6,
                    maxZoom: 19
                });

                baseLayers.satellite = L.layerGroup([satelliteBase, satelliteLabels]);

                // Инициализация кластеризации
                markerCluster = L.markerClusterGroup({
                    chunkedLoading: true,
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true,
                    iconCreateFunction: function(cluster) {
                        const count = cluster.getChildCount();
                        let size = 'small';
                        if (count > 10) size = 'medium';
                        if (count > 25) size = 'large';
                        
                        return L.divIcon({
                            html: '<div><span>' + count + '</span></div>',
                            className: 'marker-cluster marker-cluster-' + size,
                            iconSize: L.point(40, 40)
                        });
                    }
                });
                map.addLayer(markerCluster);
                
                map.addLayer(individualTargets);
                map.addLayer(allArrows);

                // Обработчики событий карты
                map.on('click', function(e) {
                    if (isAddTargetMode && isAdmin) {
                        addTargetAtPosition(e.latlng);
                        isAddTargetMode = false;
                    } else if (isCourseSelectionMode && selectedTargetForCourse) {
                        setTargetCourseFromMap(e.latlng);
                    } else if (arrowMode) {
                        handleArrowClick(e);
                    }
                });

                map.on('zoomend', function() {
                    updateTargetClusters();
                });

                map.on('mousemove', function(e) {
                    if (arrowMode && tempArrowStartLatLng && tempArrowLine) {
                        tempArrowLine.setLatLngs([tempArrowStartLatLng, e.latlng]);
                    }
                });

                console.log("Карта успішно ініціалізована");
            } catch (error) {
                console.error('Помилка ініціалізації карти:', error);
                alert('Помилка створення карти: ' + error.message);
            }
        }

        // Смена стиля карты
        function changeMapStyle() {
            const style = document.getElementById('mapStyleSelector').value;
            currentMapStyle = style;
            
            // Удаляем все текущие базовые слои
            Object.values(baseLayers).forEach(layer => {
                if (layer && map.hasLayer(layer)) {
                    map.removeLayer(layer);
                }
            });
            
            // Добавляем выбранный слой
            if (baseLayers[style]) {
                baseLayers[style].addTo(map);
            }
            
            // Обновляем все иконки маркеров для нового стиля
            updateAllMarkerIcons();
        }

        // Переключение вкладок панели
        function switchTab(tabName) {
            // Скрыть все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показать выбранную вкладку
            document.getElementById(tabName + '-tab').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            currentTab = tabName;
            
            // Обновить данные если необходимо
            if (tabName === 'statistics') {
                updateAdvancedStats();
            }
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Вкладки панели
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
            
            // Поиск с автозаполнением
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performAutoSearch(this.value);
                }, 300);
            });

            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Импорт файлов
            document.getElementById('importFile').addEventListener('change', handleFileImport);
            
            // Обработчики для новых элементов управления
            document.getElementById('trajectoryOpacity').addEventListener('input', updateTrajectorySettings);
            document.getElementById('trajectoryWidth').addEventListener('input', updateTrajectorySettings);
            document.getElementById('trajectoryLength').addEventListener('input', updateTrajectorySettings);
            document.getElementById('animationSpeed').addEventListener('input', updateTrajectorySettings);
            document.getElementById('updateInterval').addEventListener('input', updatePerformanceSettings);
            document.getElementById('maxTrajectoryPoints').addEventListener('input', updatePerformanceSettings);
        }

        // Получение иконки для типа цели
        function getIconForType(type, course = 0) {
            const iconUrl = iconConfig[currentMapStyle] && iconConfig[currentMapStyle][type];
            
            if (iconUrl) {
                return L.divIcon({
                    html: `<div class="rotatable-png-icon" style="transform: rotate(${course + 90}deg); 
                           background-image: url('${iconUrl}')"></div>`,
                    className: 'png-icon-marker',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
            }
            
            // Fallback иконка
            return createFallbackIcon(type, course);
        }

        // Создание fallback иконки
        function createFallbackIcon(type, course = 0) {
            const fallback = fallbackIcons[type] || { color: '#636e72', icon: 'fas fa-question' };
            
            return L.divIcon({
                html: `<div style="
                    width: 40px; 
                    height: 40px; 
                    background: ${fallback.color}; 
                    border-radius: 50%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    transform: rotate(${course + 90}deg);
                    border: 2px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                ">
                    <i class="${fallback.icon}" style="color: white; font-size: 16px;"></i>
                </div>`,
                className: 'custom-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
        }

        // Добавление цели на карту
        function addTargetToMap(target) {
            if (markers[target.id]) {
                if (isClusteringEnabled) {
                    markerCluster.removeLayer(markers[target.id]);
                } else {
                    individualTargets.removeLayer(markers[target.id]);
                }
            }
            
            const icon = getIconForType(target.type, target.course);
            const marker = L.marker([target.latitude, target.longitude], { icon: icon });
            
            // Форматируем дату создания
            const createdDate = new Date(target.createdAt);
            const formattedDate = createdDate.toLocaleString('uk-UA');
            
            // Создаем popup с улучшенным контентом
            const popupContent = `
                <div class="target-info-window">
                    <h4>${target.name}</h4>
                    <p><strong>Тип:</strong> ${targetTypes[target.type]?.name || target.type}</p>
                    <p><strong>Швидкість:</strong> ${target.speed} км/год</p>
                    <p><strong>Курс:</strong> ${target.course}°</p>
                    <p><strong>Група:</strong> ${targetGroups[target.group || 'default'].name}</p>
                    <p><strong>Відстань:</strong> ${(target.distance / 1000).toFixed(1)} км</p>
                    <p><strong>Паттерн:</strong> ${target.pattern || 'Лінійний'}</p>
                    <p><strong>Додано:</strong> ${formattedDate}</p>
                    ${isAdmin ? `
                    <div class="action-buttons">
                        <button class="action-button edit-btn" onclick="event.stopPropagation(); editTarget('${target.id}')">
                            <i class="fas fa-edit"></i> Редагувати
                        </button>
                        <button class="action-button delete-btn" onclick="event.stopPropagation(); deleteTarget('${target.id}')">
                            <i class="fas fa-trash"></i> Видалити
                        </button>
                        <button class="action-button course-btn" onclick="event.stopPropagation(); showCourseSelectionModal('${target.id}')">
                            <i class="fas fa-route"></i> Курс
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            marker.bindPopup(popupContent);
            
            if (isClusteringEnabled) {
                markerCluster.addLayer(marker);
            } else {
                individualTargets.addLayer(marker);
            }
            
            markers[target.id] = marker;

            // Обработчики для остановки при открытии popup
            marker.on('popupopen', function() {
                pausedTargets.add(target.id);
            });
            
            marker.on('popupclose', function() {
                pausedTargets.delete(target.id);
            });
            
            // Добавляем траекторию
            addTrajectory(target);
        }

        // Добавление траектории
        function addTrajectory(target) {
            if (!showTrajectories) return;
            
            const color = target.trajectoryColor || target.color || '#ff0000';
            
            if (polylines[target.id]) {
                map.removeLayer(polylines[target.id]);
            }
            
            if (!targetHistory[target.id]) {
                targetHistory[target.id] = [];
            }
            
            if (targetHistory[target.id].length > 1) {
                const polyline = L.polyline(targetHistory[target.id], {
                    color: color,
                    weight: trajectorySettings.width,
                    opacity: trajectorySettings.opacity,
                    smoothFactor: 1
                });
                
                polyline.addTo(map);
                polylines[target.id] = polyline;
                
                // Добавляем временные метки если включены
                if (showTimestamps) {
                    addTimestampsToTrajectory(target);
                }
            }
        }

        // Добавление временных меток на траекторию
        function addTimestampsToTrajectory(target) {
            const history = targetHistory[target.id];
            if (!history || history.length < 2) return;
            
            // Добавляем метки времени каждые 5 точек
            for (let i = 0; i < history.length; i += 5) {
                const point = history[i];
                if (point.timestamp) {
                    const time = new Date(point.timestamp).toLocaleTimeString('uk-UA', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    L.circleMarker([point.lat, point.lng], {
                        radius: 3,
                        color: target.trajectoryColor || '#00cec9',
                        fillOpacity: 0.8
                    }).bindTooltip(time, {
                        permanent: false,
                        direction: 'top'
                    }).addTo(map);
                }
            }
        }

        // Добавление цели в центр карты
        function addTargetAtCenter() {
            const center = map.getCenter();
            const newTarget = createTarget(
                center.lat,
                center.lng,
                document.getElementById('targetName').value,
                document.getElementById('targetType').value,
                parseInt(document.getElementById('targetSpeed').value),
                parseInt(document.getElementById('targetCourse').value),
                document.getElementById('targetGroup').value,
                document.getElementById('targetColor').value
            );
            
            addTarget(newTarget);
            
            // Автоинкремент названия
            const nameInput = document.getElementById('targetName');
            const match = nameInput.value.match(/^(.*?)(\d+)$/);
            if (match) {
                const base = match[1];
                const num = parseInt(match[2]) + 1;
                nameInput.value = base + num;
            } else {
                nameInput.value = nameInput.value + '-2';
            }
        }

        // Создание объекта цели
        function createTarget(lat, lng, name, type, speed, course, group = 'default', color = '#ff0000') {
            return {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                name: name || 'Ціль-' + (targets.length + 1),
                type: type || 'дрон',
                latitude: lat,
                longitude: lng,
                speed: speed || 150,
                course: course || 0,
                group: group || 'default',
                trajectoryColor: color || '#ff0000',
                createdAt: new Date().toISOString(),
                distance: 0,
                pattern: currentMovementPattern,
                patternData: {}
            };
        }

        // Добавление цели
        function addTarget(target) {
            targets.push(target);
            targetHistory[target.id] = [{
                lat: target.latitude,
                lng: target.longitude,
                timestamp: Date.now()
            }];
            
            addTargetToMap(target);
            updateTargetsList();
            updateStats();
            saveToLocalStorage();
        }

        // Обновление списка целей
        function updateTargetsList() {
            const targetsList = document.getElementById('targetsList');
            targetsList.innerHTML = '';
            
            // Группировка целей по группам
            const groupedTargets = {};
            targets.forEach(target => {
                const group = target.group || 'default';
                if (!groupedTargets[group]) {
                    groupedTargets[group] = [];
                }
                groupedTargets[group].push(target);
            });
            
            Object.keys(groupedTargets).forEach(groupKey => {
                const groupTargets = groupedTargets[groupKey];
                const groupInfo = targetGroups[groupKey] || { name: groupKey, color: '#636e72' };
                
                // Заголовок группы
                const groupHeader = document.createElement('div');
                groupHeader.style.cssText = `
                    color: ${groupInfo.color};
                    font-weight: bold;
                    margin: 10px 0 5px 0;
                    padding: 5px;
                    background: rgba(52, 73, 94, 0.3);
                    border-radius: 3px;
                    font-size: 12px;
                `;
                groupHeader.textContent = `${groupInfo.name} (${groupTargets.length})`;
                targetsList.appendChild(groupHeader);
                
                groupTargets.forEach(target => {
                    const targetElement = document.createElement('div');
                    targetElement.className = 'target-item';
                    targetElement.style.borderLeftColor = target.trajectoryColor || groupInfo.color;
                    
                    targetElement.innerHTML = `
                        <h4>
                            ${target.name}
                            <span style="font-size: 10px; color: #dfe6e9;">
                                ${targetTypes[target.type]?.name || target.type}
                            </span>
                        </h4>
                        <p>Швидкість: ${target.speed} км/год | Курс: ${target.course}°</p>
                        <p>Відстань: ${(target.distance / 1000).toFixed(1)} км</p>
                        <p>Паттерн: ${target.pattern || 'Лінійний'}</p>
                        ${isAdmin ? `
                        <div class="target-actions">
                            <button class="btn btn-small" onclick="focusOnTarget('${target.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-small" onclick="editTarget('${target.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteTarget('${target.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ` : ''}
                    `;
                    
                    targetsList.appendChild(targetElement);
                });
            });
        }

        // Фокусировка на цели
        function focusOnTarget(targetId) {
            const target = targets.find(t => t.id === targetId);
            if (target && markers[target.id]) {
                map.setView([target.latitude, target.longitude], 12);
                markers[target.id].openPopup();
            }
        }

        // Редактирование цели
        function editTarget(targetId) {
            const target = targets.find(t => t.id === targetId);
            if (!target) return;
            
            currentEditTargetId = targetId;
            
            document.getElementById('editName').value = target.name;
            document.getElementById('editType').value = target.type;
            document.getElementById('editSpeed').value = target.speed;
            document.getElementById('editCourse').value = target.course;
            document.getElementById('editGroup').value = target.group || 'default';
            document.getElementById('editColor').value = target.trajectoryColor || '#ff0000';
            
            document.getElementById('editModal').style.display = 'block';
        }

        // Сохранение изменений цели
        function saveTargetEdit() {
            if (!currentEditTargetId) return;
            
            const target = targets.find(t => t.id === currentEditTargetId);
            if (!target) return;
            
            target.name = document.getElementById('editName').value;
            target.type = document.getElementById('editType').value;
            target.speed = parseInt(document.getElementById('editSpeed').value);
            target.course = parseInt(document.getElementById('editCourse').value);
            target.group = document.getElementById('editGroup').value;
            target.trajectoryColor = document.getElementById('editColor').value;
            
            // Обновляем маркер на карте
            addTargetToMap(target);
            updateTargetsList();
            updateStats();
            saveToLocalStorage();
            
            closeEditModal();
        }

        // Закрытие модального окна редактирования
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditTargetId = null;
        }

        // Удаление цели
        function deleteTarget(targetId) {
            if (!confirm('Ви впевнені, що хочете видалити цю ціль?')) return;
            
            targets = targets.filter(t => t.id !== targetId);
            
            if (markers[targetId]) {
                if (isClusteringEnabled) {
                    markerCluster.removeLayer(markers[targetId]);
                } else {
                    individualTargets.removeLayer(markers[targetId]);
                }
                delete markers[targetId];
            }
            
            if (polylines[targetId]) {
                map.removeLayer(polylines[targetId]);
                delete polylines[targetId];
            }
            
            delete targetHistory[targetId];
            
            updateTargetsList();
            updateStats();
            saveToLocalStorage();
        }

        // Установка паттерна движения
        function setMovementPattern(pattern) {
            currentMovementPattern = pattern;
            
            // Обновляем UI
            document.querySelectorAll('.pattern-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-pattern="${pattern}"]`).classList.add('active');
            
            // Применяем к выбранным целям
            targets.forEach(target => {
                target.pattern = pattern;
                target.patternData = {};
            });
            
            saveToLocalStorage();
        }

        // Движение целей с различными паттернами
        function moveTargets() {
            if (performanceMode && frameCount % 3 !== 0) return;
            
            const now = Date.now();
            const deltaTime = (now - lastUpdateTime) / 1000; // в секундах
            lastUpdateTime = now;
            
            targets.forEach(target => {
                if (pausedTargets.has(target.id)) return;
                
                const speedMs = (target.speed * 1000) / 3600; // м/с
                const distance = speedMs * deltaTime * trajectorySettings.animationSpeed;
                
                let newLat = target.latitude;
                let newLng = target.longitude;
                
                // Применяем паттерн движения
                switch (target.pattern) {
                    case 'linear':
                        const courseRad = (target.course * Math.PI) / 180;
                        const latOffset = (distance / 111000) * Math.cos(courseRad);
                        const lngOffset = (distance / (111000 * Math.cos(target.latitude * Math.PI / 180))) * Math.sin(courseRad);
                        
                        newLat = target.latitude + latOffset;
                        newLng = target.longitude + lngOffset;
                        break;
                        
                    case 'zigzag':
                        if (!target.patternData.zigzagTime) target.patternData.zigzagTime = 0;
                        target.patternData.zigzagTime += deltaTime;
                        
                        const zigzagOffset = Math.sin(target.patternData.zigzagTime * 2) * 0.001;
                        const baseCourse = (target.course * Math.PI) / 180;
                        
                        newLat = target.latitude + (distance / 111000) * Math.cos(baseCourse) + zigzagOffset;
                        newLng = target.longitude + (distance / (111000 * Math.cos(target.latitude * Math.PI / 180))) * Math.sin(baseCourse);
                        break;
                        
                    case 'spiral':
                        if (!target.patternData.spiralAngle) target.patternData.spiralAngle = 0;
                        if (!target.patternData.spiralRadius) target.patternData.spiralRadius = 0.01;
                        
                        target.patternData.spiralAngle += deltaTime * 0.5;
                        target.patternData.spiralRadius += deltaTime * 0.001;
                        
                        newLat = target.latitude + target.patternData.spiralRadius * Math.cos(target.patternData.spiralAngle);
                        newLng = target.longitude + target.patternData.spiralRadius * Math.sin(target.patternData.spiralAngle);
                        break;
                        
                    case 'circle':
                        if (!target.patternData.circleAngle) target.patternData.circleAngle = 0;
                        if (!target.patternData.circleCenter) {
                            target.patternData.circleCenter = { lat: target.latitude, lng: target.longitude };
                            target.patternData.circleRadius = 0.02;
                        }
                        
                        target.patternData.circleAngle += deltaTime * 0.3;
                        
                        newLat = target.patternData.circleCenter.lat + target.patternData.circleRadius * Math.cos(target.patternData.circleAngle);
                        newLng = target.patternData.circleCenter.lng + target.patternData.circleRadius * Math.sin(target.patternData.circleAngle);
                        break;
                        
                    case 'patrol':
                        if (!target.patternData.patrolDirection) target.patternData.patrolDirection = 1;
                        if (!target.patternData.patrolDistance) target.patternData.patrolDistance = 0;
                        if (!target.patternData.patrolMaxDistance) target.patternData.patrolMaxDistance = 0.05;
                        
                        const patrolCourse = (target.course * Math.PI) / 180;
                        const patrolStep = distance / 111000 * target.patternData.patrolDirection;
                        
                        newLat = target.latitude + patrolStep * Math.cos(patrolCourse);
                        newLng = target.longitude + patrolStep * Math.sin(patrolCourse);
                        
                        target.patternData.patrolDistance += Math.abs(patrolStep);
                        
                        if (target.patternData.patrolDistance >= target.patternData.patrolMaxDistance) {
                            target.patternData.patrolDirection *= -1;
                            target.patternData.patrolDistance = 0;
                        }
                        break;
                        
                    case 'random':
                        const randomCourse = Math.random() * 2 * Math.PI;
                        const randomDistance = distance * (0.5 + Math.random());
                        
                        newLat = target.latitude + (randomDistance / 111000) * Math.cos(randomCourse);
                        newLng = target.longitude + (randomDistance / (111000 * Math.cos(target.latitude * Math.PI / 180))) * Math.sin(randomCourse);
                        break;
                }
                
                // Обновляем позицию цели
                target.latitude = newLat;
                target.longitude = newLng;
                target.distance += distance;
                
                // Обновляем историю траектории
                if (!targetHistory[target.id]) {
                    targetHistory[target.id] = [];
                }
                
                targetHistory[target.id].push({
                    lat: target.latitude,
                    lng: target.longitude,
                    timestamp: now
                });
                
                // Ограничиваем длину истории
                if (targetHistory[target.id].length > maxTrajectoryPoints) {
                    targetHistory[target.id].shift();
                }
                
                // Обновляем маркер на карте
                if (markers[target.id]) {
                    markers[target.id].setLatLng([target.latitude, target.longitude]);
                    
                    // Обновляем поворот маркера для линейного движения
                    if (target.pattern === 'linear') {
                        const icon = getIconForType(target.type, target.course);
                        markers[target.id].setIcon(icon);
                    }
                }
                
                // Обновляем траекторию
                addTrajectory(target);
            });
        }

        // Обновление всех иконок маркеров
        function updateAllMarkerIcons() {
            targets.forEach(target => {
                if (markers[target.id]) {
                    const icon = getIconForType(target.type, target.course);
                    markers[target.id].setIcon(icon);
                }
            });
        }

        // Переключение отображения траекторий
        function toggleTrajectories() {
            showTrajectories = !showTrajectories;
            
            const toggleText = document.getElementById('trajectoryToggleText');
            if (showTrajectories) {
                toggleText.textContent = 'Приховати траєкторії';
                // Показать все траектории
                targets.forEach(target => {
                    addTrajectory(target);
                });
            } else {
                toggleText.textContent = 'Показати траєкторії';
                // Скрыть все траектории
                Object.values(polylines).forEach(polyline => {
                    map.removeLayer(polyline);
                });
            }
        }

        // Очистка всех траекторий
        function clearAllTrajectories() {
            if (!confirm('Очистити всі траєкторії?')) return;
            
            Object.values(polylines).forEach(polyline => {
                map.removeLayer(polyline);
            });
            
            polylines = {};
            targetHistory = {};
            
            // Сбросить расстояния
            targets.forEach(target => {
                target.distance = 0;
                targetHistory[target.id] = [{
                    lat: target.latitude,
                    lng: target.longitude,
                    timestamp: Date.now()
                }];
            });
            
            updateStats();
        }

        // Обновление настроек траекторий
        function updateTrajectorySettings() {
            trajectorySettings.opacity = parseFloat(document.getElementById('trajectoryOpacity').value);
            trajectorySettings.width = parseInt(document.getElementById('trajectoryWidth').value);
            trajectorySettings.length = parseInt(document.getElementById('trajectoryLength').value);
            trajectorySettings.animationSpeed = parseFloat(document.getElementById('animationSpeed').value);
            
            // Обновить отображаемые значения
            document.getElementById('opacityValue').textContent = Math.round(trajectorySettings.opacity * 100) + '%';
            document.getElementById('widthValue').textContent = trajectorySettings.width + 'px';
            document.getElementById('lengthValue').textContent = trajectorySettings.length + ' точок';
            document.getElementById('speedValue').textContent = trajectorySettings.animationSpeed + 'x';
            
            // Перерисовать все траектории с новыми настройками
            targets.forEach(target => {
                addTrajectory(target);
            });
        }

        // Обновление настроек производительности
        function updatePerformanceSettings() {
            updateInterval = parseInt(document.getElementById('updateInterval').value);
            maxTrajectoryPoints = parseInt(document.getElementById('maxTrajectoryPoints').value);
            
            document.getElementById('intervalValue').textContent = updateInterval + 'ms';
            document.getElementById('maxPointsValue').textContent = maxTrajectoryPoints + ' точок';
        }

        // Инициализация слайдеров
        function initializeRangeSliders() {
            updateTrajectorySettings();
            updatePerformanceSettings();
        }

        // Обновление статистики
        function updateStats() {
            const totalTargets = targets.length;
            const activeTargets = targets.filter(t => !pausedTargets.has(t.id)).length;
            const maxSpeed = Math.max(...targets.map(t => t.speed), 0);
            const avgSpeed = targets.length > 0 ? Math.round(targets.reduce((sum, t) => sum + t.speed, 0) / targets.length) : 0;
            const totalDistance = targets.reduce((sum, t) => sum + t.distance, 0);
            
            document.getElementById('totalTargets').textContent = totalTargets;
            document.getElementById('activeTargets').textContent = activeTargets;
            document.getElementById('maxSpeed').textContent = maxSpeed;
            document.getElementById('avgSpeed').textContent = avgSpeed;
            document.getElementById('totalDistance').textContent = Math.round(totalDistance / 1000);
            
            // Обновление времени работы
            const uptime = Date.now() - startTime;
            const hours = Math.floor(uptime / (1000 * 60 * 60));
            const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('onlineTime').textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Расширенная статистика
        function updateAdvancedStats() {
            updateStats();
            updateTargetTypesChart();
            updateGroupStats();
        }

        // Обновление графика типов целей
        function updateTargetTypesChart() {
            const ctx = document.getElementById('targetTypesChart').getContext('2d');
            
            // Подсчет целей по типам
            const typeCounts = {};
            targets.forEach(target => {
                typeCounts[target.type] = (typeCounts[target.type] || 0) + 1;
            });
            
            const labels = Object.keys(typeCounts).map(type => targetTypes[type]?.name || type);
            const data = Object.values(typeCounts);
            const colors = Object.keys(typeCounts).map(type => fallbackIcons[type]?.color || '#636e72');
            
            if (targetChart) {
                targetChart.destroy();
            }
            
            targetChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#2d3436'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#dfe6e9',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        // Обновление статистики по группам
        function updateGroupStats() {
            const groupStats = document.getElementById('groupStats');
            groupStats.innerHTML = '';
            
            const groupCounts = {};
            targets.forEach(target => {
                const group = target.group || 'default';
                groupCounts[group] = (groupCounts[group] || 0) + 1;
            });
            
            Object.keys(groupCounts).forEach(groupKey => {
                const count = groupCounts[groupKey];
                const groupInfo = targetGroups[groupKey] || { name: groupKey, color: '#636e72' };
                
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <h4 style="color: ${groupInfo.color};">${count}</h4>
                    <p>${groupInfo.name}</p>
                `;
                
                groupStats.appendChild(statCard);
            });
        }

        // Переключение панели
        function togglePanel() {
            const panel = document.getElementById('sidePanel');
            const button = document.querySelector('.toggle-panel-btn');
            
            isPanelExpanded = !isPanelExpanded;
            
            if (isPanelExpanded) {
                panel.classList.remove('collapsed');
                button.innerHTML = '<i class="fas fa-eye-slash"></i><span>Панель</span>';
            } else {
                panel.classList.add('collapsed');
                button.innerHTML = '<i class="fas fa-eye"></i><span>Панель</span>';
            }
        }

        // Переключение полноэкранного режима
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Помилка входу в повноекранний режим:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Переключение кластеризации
        function toggleClustering() {
            isClusteringEnabled = !isClusteringEnabled;
            const button = document.getElementById('toggleClusterBtn');
            
            if (isClusteringEnabled) {
                button.innerHTML = '<i class="fas fa-object-group"></i>Кластеризація: Увімкнена';
                // Переместить маркеры в кластер
                individualTargets.eachLayer(layer => {
                    individualTargets.removeLayer(layer);
                    markerCluster.addLayer(layer);
                });
            } else {
                button.innerHTML = '<i class="fas fa-object-ungroup"></i>Кластеризація: Вимкнена';
                // Переместить маркеры из кластера
                markerCluster.eachLayer(layer => {
                    markerCluster.removeLayer(layer);
                    individualTargets.addLayer(layer);
                });
            }
        }

        // Переключение режима стрелок
        function toggleArrowMode() {
            arrowMode = !arrowMode;
            const button = document.getElementById('toggleArrowBtn');
            
            if (arrowMode) {
                button.innerHTML = '<i class="fas fa-times"></i>Вимкнути стрілки';
                map.getContainer().style.cursor = 'crosshair';
            } else {
                button.innerHTML = '<i class="fas fa-draw-polygon"></i>Режим стрілок';
                map.getContainer().style.cursor = '';
                
                if (tempArrowLine) {
                    map.removeLayer(tempArrowLine);
                    tempArrowLine = null;
                    tempArrowStartLatLng = null;
                }
            }
        }

        // Переключение временных меток
        function toggleTimestamps() {
            showTimestamps = !showTimestamps;
            
            if (showTimestamps) {
                targets.forEach(target => {
                    addTimestampsToTrajectory(target);
                });
            } else {
                // Удалить все временные метки
                map.eachLayer(layer => {
                    if (layer instanceof L.CircleMarker && layer.getTooltip()) {
                        map.removeLayer(layer);
                    }
                });
            }
        }

        // Переключение сетки координат
        function toggleGrid() {
            showGrid = !showGrid;
            
            if (showGrid) {
                // Добавить сетку координат (упрощенная версия)
                // Здесь можно добавить более сложную сетку
                console.log('Сетка координат включена');
            } else {
                console.log('Сетка координат выключена');
            }
        }

        // Переключение режима производительности
        function togglePerformanceMode() {
            performanceMode = !performanceMode;
            
            if (performanceMode) {
                alert('Режим продуктивності увімкнено. Анімація буде оновлюватися рідше для кращої продуктивності.');
            } else {
                alert('Режим продуктивності вимкнено. Анімація буде працювати на повній швидкості.');
            }
        }

        // Основной цикл анимации
        function startAnimationLoop() {
            function animate() {
                frameCount++;
                
                // Обновление FPS каждую секунду
                const now = Date.now();
                if (now - lastFPSUpdate >= 1000) {
                    currentFPS = Math.round(frameCount * 1000 / (now - lastFPSUpdate));
                    document.getElementById('fpsCounter').textContent = currentFPS;
                    frameCount = 0;
                    lastFPSUpdate = now;
                }
                
                // Движение целей
                moveTargets();
                
                // Обновление статистики каждые 5 секунд
                if (now - lastStatsUpdate >= 5000) {
                    updateStats();
                    lastStatsUpdate = now;
                }
                
                animationFrameId = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // Поиск городов
        function performAutoSearch(query) {
            if (!query || query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            const results = ukraineCities.filter(city => 
                city.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10);
            
            displaySearchResults(results);
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;
            
            performAutoSearch(query);
        }

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            results.forEach(city => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <strong>${city.name}</strong>
                    <br><small>${city.type}</small>
                `;
                
                item.addEventListener('click', () => {
                    map.setView([city.lat, city.lng], 10);
                    document.getElementById('searchInput').value = city.name;
                    resultsContainer.style.display = 'none';
                    
                    // Добавить временный маркер
                    if (searchMarker) {
                        map.removeLayer(searchMarker);
                    }
                    
                    searchMarker = L.marker([city.lat, city.lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #00cec9; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>',
                            className: 'search-marker',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map);
                    
                    setTimeout(() => {
                        if (searchMarker) {
                            map.removeLayer(searchMarker);
                            searchMarker = null;
                        }
                    }, 5000);
                });
                
                resultsContainer.appendChild(item);
            });
            
            resultsContainer.style.display = 'block';
        }

        // Экспорт данных
        function exportTargets() {
            const data = {
                targets: targets,
                trajectorySettings: trajectorySettings,
                exportDate: new Date().toISOString(),
                version: "2.0"
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `targets_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Экспорт в CSV
        function exportCSV() {
            const csvHeader = 'ID,Назва,Тип,Широта,Довгота,Швидкість,Курс,Група,Колір,Відстань,Створено\n';
            const csvContent = targets.map(target => 
                `${target.id},${target.name},${target.type},${target.latitude},${target.longitude},${target.speed},${target.course},${target.group || 'default'},${target.trajectoryColor || '#ff0000'},${(target.distance / 1000).toFixed(1)},${target.createdAt}`
            ).join('\n');
            
            const blob = new Blob([csvHeader + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `targets_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // Импорт файлов
        function importTargets() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (file.name.endsWith('.json')) {
                        data = JSON.parse(e.target.result);
                        
                        if (data.targets && Array.isArray(data.targets)) {
                            const importCount = data.targets.length;
                            
                            if (confirm(`Імпортувати ${importCount} цілей? Це додасть їх до поточного списку.`)) {
                                data.targets.forEach(target => {
                                    target.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                                    addTarget(target);
                                });
                                
                                if (data.trajectorySettings) {
                                    Object.assign(trajectorySettings, data.trajectorySettings);
                                    initializeRangeSliders();
                                }
                                
                                alert(`Успішно імпортовано ${importCount} цілей!`);
                            }
                        } else {
                            throw new Error('Некоректний формат файлу');
                        }
                    } else if (file.name.endsWith('.csv')) {
                        // Простой парсер CSV
                        const lines = e.target.result.split('\n');
                        const headers = lines[0].split(',');
                        
                        if (!headers.includes('Назва') || !headers.includes('Тип')) {
                            throw new Error('Некоректний CSV файл');
                        }
                        
                        const importedTargets = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = line.split(',');
                            if (values.length >= 8) {
                                const target = createTarget(
                                    parseFloat(values[3]) || 50.45,
                                    parseFloat(values[4]) || 30.52,
                                    values[1] || 'Імпортована ціль',
                                    values[2] || 'дрон',
                                    parseInt(values[5]) || 150,
                                    parseInt(values[6]) || 0,
                                    values[7] || 'default',
                                    values[8] || '#ff0000'
                                );
                                importedTargets.push(target);
                            }
                        }
                        
                        if (importedTargets.length > 0) {
                            if (confirm(`Імпортувати ${importedTargets.length} цілей з CSV?`)) {
                                importedTargets.forEach(addTarget);
                                alert(`Успішно імпортовано ${importedTargets.length} цілей!`);
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error('Помилка імпорту:', error);
                    alert('Помилка при імпорті файлу: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Очистка всех целей
        function clearAllTargets() {
            if (!confirm('Видалити всі цілі? Ця дія незворотна!')) return;
            
            targets = [];
            
            Object.values(markers).forEach(marker => {
                if (isClusteringEnabled) {
                    markerCluster.removeLayer(marker);
                } else {
                    individualTargets.removeLayer(marker);
                }
            });
            
            Object.values(polylines).forEach(polyline => {
                map.removeLayer(polyline);
            });
            
            markers = {};
            polylines = {};
            targetHistory = {};
            pausedTargets.clear();
            
            updateTargetsList();
            updateStats();
            saveToLocalStorage();
        }

        // Сохранение в localStorage
        function saveToLocalStorage() {
            try {
                const data = {
                    targets: targets,
                    trajectorySettings: trajectorySettings,
                    currentMovementPattern: currentMovementPattern,
                    performanceMode: performanceMode,
                    updateInterval: updateInterval,
                    maxTrajectoryPoints: maxTrajectoryPoints,
                    savedAt: Date.now()
                };
                localStorage.setItem('airTargetsData', JSON.stringify(data));
            } catch (error) {
                console.error('Помилка збереження:', error);
            }
        }

        // Загрузка из localStorage
        function loadTargetsFromLocalStorage() {
            try {
                const data = localStorage.getItem('airTargetsData');
                if (data) {
                    const parsed = JSON.parse(data);
                    
                    if (parsed.targets && Array.isArray(parsed.targets)) {
                        parsed.targets.forEach(target => {
                            // Инициализируем историю траектории
                            targetHistory[target.id] = [{
                                lat: target.latitude,
                                lng: target.longitude,
                                timestamp: target.createdAt ? new Date(target.createdAt).getTime() : Date.now()
                            }];
                            addTargetToMap(target);
                        });
                        targets = parsed.targets;
                        updateTargetsList();
                    }
                    
                    if (parsed.trajectorySettings) {
                        Object.assign(trajectorySettings, parsed.trajectorySettings);
                    }
                    
                    if (parsed.currentMovementPattern) {
                        setMovementPattern(parsed.currentMovementPattern);
                    }
                    
                    if (parsed.performanceMode !== undefined) {
                        performanceMode = parsed.performanceMode;
                    }
                    
                    if (parsed.updateInterval) {
                        updateInterval = parsed.updateInterval;
                    }
                    
                    if (parsed.maxTrajectoryPoints) {
                        maxTrajectoryPoints = parsed.maxTrajectoryPoints;
                    }
                    
                    console.log(`Завантажено ${targets.length} цілей з локального сховища`);
                }
            } catch (error) {
                console.error('Помилка завантаження з localStorage:', error);
            }
        }

        // Очистка localStorage
        function clearLocalStorage() {
            if (!confirm('Очистити всі збережені дані? Ця дія незворотна!')) return;
            
            localStorage.removeItem('airTargetsData');
            localStorage.removeItem('warningShown');
            alert('Локальне сховище очищено');
        }

        // Автосохранение
        function startAutoSave() {
            autoSaveInterval = setInterval(() => {
                saveToLocalStorage();
            }, 30000); // каждые 30 секунд
        }

        // Проверка подключения
        function checkConnection() {
            const status = navigator.onLine ? 'Онлайн' : 'Офлайн';
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            
            let connectionInfo = `Статус: ${status}\n`;
            if (connection) {
                connectionInfo += `Тип з'єднання: ${connection.effectiveType || 'Невідомо'}\n`;
                connectionInfo += `Швидкість: ${connection.downlink || 'Невідомо'} Mbps`;
            }
            
            alert(connectionInfo);
        }

        // Простые функции для совместимости с оригиналом
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function attemptLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Простая проверка (замените на реальную аутентификацию)
            if (email === 'admin@example.com' && password === 'admin') {
                isAdmin = true;
                updateUIForUserRole();
                closeLoginModal();
                alert('Ви увійшли як адміністратор');
            } else {
                alert('Невірний email або пароль');
            }
        }

        function logout() {
            isAdmin = false;
            updateUIForUserRole();
        }

        function updateUIForUserRole() {
            const loginBtn = document.querySelector('.login-btn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (isAdmin) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'flex';
            } else {
                loginBtn.style.display = 'flex';
                logoutBtn.style.display = 'none';
            }
            
            updateTargetsList();
        }

        function updateStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                statusDot.className = 'online-dot';
                statusText.textContent = 'Онлайн';
                statusText.style.color = '#00b894';
            } else {
                statusDot.className = 'offline-dot';
                statusText.textContent = 'Локальний режим';
                statusText.style.color = '#f39c12';
            }
            
            document.getElementById('lastUpdate').textContent = 
                'Оновлено: ' + new Date().toLocaleTimeString('uk-UA');
        }

        // Заглушки для Firebase функций
        function initFirebase() {
            try {
                if (typeof firebase !== 'undefined' && firebaseConfig) {
                    firebase.initializeApp(firebaseConfig);
                    isOnline = true;
                    console.log('Firebase ініціалізовано');
                } else {
                    console.log('Firebase недоступний, працюємо в локальному режимі');
                }
            } catch (error) {
                console.error('Помилка ініціалізації Firebase:', error);
            }
            updateStatus();
        }

        function reconnectFirebase() {
            console.log("Спроба переподключення до Firebase...");
            initFirebase();
        }

        // Заглушки для функций которые есть в оригинале но не реализованы здесь
        function showCourseSelectionModal() { console.log('Course selection modal'); }
        function confirmCourseSelection() { console.log('Course confirmed'); }
        function cancelCourseSelection() { console.log('Course cancelled'); }
        function handleArrowClick() { console.log('Arrow click'); }
        function updateTargetClusters() { console.log('Update clusters'); }
        function addTargetAtPosition() { console.log('Add target at position'); }
        function setTargetCourseFromMap() { console.log('Set course from map'); }

        // Запуск приложения
        document.addEventListener('DOMContentLoaded', initApp);
