<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏—Ö —Ü—ñ–ª–µ–π</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { padding: 20px; background: #1a1f2d; color: white; font-family: Arial, sans-serif; }
        #map { 
            height: 600px; 
            width: 100%; 
            border: 2px solid #a38d6d; 
            border-radius: 8px; 
            margin-bottom: 20px;
            background: #2c3e50; /* –§–æ–Ω –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è */
        }
        .map-error {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #e74c3c;
            font-size: 18px;
            text-align: center;
        }
        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        .btn { padding: 10px 15px; background: #a38d6d; color: white; border: none; border-radius: 5px; margin: 5px; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn:hover { background: #8a7559; }
        .controls { margin: 10px 0; display: flex; flex-wrap: wrap; }
        /* ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ ... */
    </style>
</head>
<body>
    <h1>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏—Ö —Ü—ñ–ª–µ–π</h1>
    <div class="sync-info" id="syncInfo">–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</div>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="üîç –ü–æ—à—É–∫ –Ω–∞—Å–µ–ª–µ–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É...">
        <div id="searchResults"></div>
    </div>

    <div class="controls">
        <button class="btn" onclick="centerMap()">üéØ –¶–µ–Ω—Ç—Ä—É–≤–∞—Ç–∏</button>
        <button class="btn" onclick="toggleAddMode()" id="addModeBtn">üìç –î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å –∫–ª—ñ–∫–æ–º</button>
        <button class="btn" onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
        <button class="btn" onclick="toggleTrails()" id="trailsBtn">üî¥ –¢—Ä–∞—î–∫—Ç–æ—Ä—ñ—ó</button>
        <button class="btn" onclick="toggleMapView()" id="mapViewBtn">üõ∞Ô∏è –°—É–ø—É—Ç–Ω–∏–∫</button>
        <button class="btn" onclick="showAllTargets()">üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç–∏ –≤—Å—ñ —Ü—ñ–ª—ñ</button>
        <button class="btn" onclick="forceSync()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏</button>
    </div>

    <div id="map">
        <div class="map-error" id="mapError" style="display: none;">
            –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏. –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É.
        </div>
    </div>

    <h3>üéØ –ê–∫—Ç–∏–≤–Ω—ñ —Ü—ñ–ª—ñ:</h3>
    <div id="targetsList">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–µ–ª–∏ -->
    <div id="targetForm" class="modal">
        <div class="modal-content">
            <h3 id="formTitle">‚ûï –î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å</h3>
            <input type="hidden" id="targetId">
            <input type="text" id="targetName" placeholder="–ù–∞–∑–≤–∞ —Ü—ñ–ª—ñ">
            <input type="number" id="targetSpeed" placeholder="–®–≤–∏–¥–∫—ñ—Å—Ç—å (–∫–º/–≥–æ–¥)">
            <input type="number" id="targetCourse" placeholder="–ö—É—Ä—Å (0-360¬∞)" min="0" max="360">
            <select id="targetType">
                <option value="–≤–∏–Ω–∏—â—É–≤–∞—á">–í–∏–Ω–∏—â—É–≤–∞—á</option>
                <option value="–¥—Ä–æ–Ω">–î—Ä–æ–Ω (Shahed)</option>
                <option value="—Ä–∞–∫–µ—Ç–∞">–†–∞–∫–µ—Ç–∞</option>
                <option value="–±–æ–º–±–∞">–ë–æ–º–±–∞</option>
                <option value="–∫–æ—Ä–∞–±–ª—å">–ö–æ—Ä–∞–±–µ–ª—å</option>
            </select>
            <div style="margin-top:15px;">
                <button class="btn" onclick="saveTarget()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
                <button class="btn" onclick="deleteTarget()" style="background:#ff0000;">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                <button class="btn" onclick="hideTargetForm()" style="background:#e74c3c;">‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ Firebase - –¢–û–õ–¨–ö–û –õ–û–ö–ê–õ–¨–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
let map;
let markers = {};
let animationPaused = false;
let courseMode = false;
let addMode = false;
let trailsVisible = true;
let selectedTargetId = null;
let currentMapView = 'street';
let baseLayers = {};
let targets = [];
let animationInterval;
let nextId = 1;
let targetTrails = {};
let targetHistory = {};
let clickMarker = null;
let lastFrameTime = performance.now();
let hiddenTargets = new Set();

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
const syncInfo = document.getElementById('syncInfo');
const mapError = document.getElementById('mapError');

// –§—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ LocalStorage
function saveToLocalStorage() {
    const data = {
        targets: targets,
        nextId: nextId,
        targetHistory: targetHistory,
        lastUpdate: Date.now()
    };
    localStorage.setItem('airTargetsData', JSON.stringify(data));
    syncInfo.textContent = `–ó–±–µ—Ä–µ–∂–µ–Ω–æ: ${new Date().toLocaleTimeString()}`;
}

function loadFromLocalStorage() {
    const savedData = localStorage.getItem('airTargetsData');
    if (savedData) {
        try {
            const data = JSON.parse(savedData);
            targets = data.targets || [];
            nextId = data.nextId || 1;
            targetHistory = data.targetHistory || {};
            
            targets.forEach(target => {
                if (!targetHistory[target.id]) {
                    targetHistory[target.id] = [[target.lat, target.lng]];
                }
            });
            
            return true;
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:", error);
            return false;
        }
    }
    return false;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
function initMap() {
    console.log("–°–ø—Ä–æ–±—É—é —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É...");
    
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Leaflet
        if (typeof L === 'undefined') {
            throw new Error("–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∫–∞—Ä—Ç–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—å");
        }
        
        map = L.map('map').setView([50.4501, 30.5234], 6);

        baseLayers.street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        });

        baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '¬© Esri',
            maxZoom: 19
        });

        baseLayers.street.addTo(map);

        // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        mapError.style.display = 'none';

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        if (!loadFromLocalStorage()) {
            loadDefaultTargets();
        }
        
        startAnimation();
        updateMapMarkers();
        updateTargetsList();
        
        console.log("–ö–∞—Ä—Ç–∞ —É—Å–ø—ñ—à–Ω–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞");
        
    } catch (error) {
        console.error("–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:", error);
        mapError.style.display = 'flex';
        mapError.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏: ' + error.message;
        
        // –í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–±–æ—Ç–∞–ª
        if (!loadFromLocalStorage()) {
            loadDefaultTargets();
        }
        updateTargetsList();
    }
}

function loadDefaultTargets() {
    if (targets.length === 0) {
        targets = [
            {id: nextId++, name: "F-16", type: "–≤–∏–Ω–∏—â—É–≤–∞—á", speed: 800, course: 45, lat: 50.45, lng: 30.52, lastUpdate: Date.now()},
            {id: nextId++, name: "Shahed-136", type: "–¥—Ä–æ–Ω", speed: 180, course: 120, lat: 49.0, lng: 31.0, lastUpdate: Date.now()}
        ];

        targets.forEach(target => {
            targetHistory[target.id] = [[target.lat, target.lng]];
        });
    }
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function toggleAddMode() {
    addMode = !addMode;
    const btn = document.getElementById('addModeBtn');
    btn.textContent = addMode ? '‚ùå –°–∫–∞—Å—É–≤–∞—Ç–∏' : 'üìç –î–æ–¥–∞—Ç–∏ —Ü—ñ–ª—å';
    btn.style.background = addMode ? '#e74c3c' : '#a38d6d';
}

function showTargetForm(targetId, latlng = null) {
    const form = document.getElementById('targetForm');
    form.style.display = 'flex';
    
    if (latlng) {
        window.newTargetLatLng = latlng;
    }
}

function saveTarget() {
    const name = document.getElementById('targetName').value || '–¶—ñ–ª—å ' + nextId;
    const speed = parseFloat(document.getElementById('targetSpeed').value) || 100;
    const course = parseFloat(document.getElementById('targetCourse').value) || 0;
    const type = document.getElementById('targetType').value;

    const center = map.getCenter();
    const newTarget = {
        id: nextId++,
        name: name,
        type: type,
        speed: speed,
        course: course,
        lat: center.lat,
        lng: center.lng,
        lastUpdate: Date.now()
    };

    targets.push(newTarget);
    targetHistory[newTarget.id] = [[center.lat, center.lng]];

    updateMapMarkers();
    updateTargetsList();
    saveToLocalStorage();
    
    hideTargetForm();
}

function updateMapMarkers() {
    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –∫–∞—Ä—Ç—ã
    updateTargetsList();
}

function updateTargetsList() {
    const container = document.getElementById('targetsList');
    container.innerHTML = '';
    
    targets.forEach(target => {
        const div = document.createElement('div');
        div.className = 'target-item';
        div.innerHTML = `
            <strong>${target.name}</strong> (${target.type})<br>
            –®–≤–∏–¥–∫—ñ—Å—Ç—å: ${target.speed} –∫–º/–≥–æ–¥, –ö—É—Ä—Å: ${target.course}¬∞<br>
            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏: ${target.lat.toFixed(4)}, ${target.lng.toFixed(4)}
        `;
        container.appendChild(div);
    });
}

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
    setTimeout(initMap, 100);
});

// –ü—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
function togglePause() {
    animationPaused = !animationPaused;
    document.getElementById('pauseBtn').textContent = animationPaused ? '‚ñ∂Ô∏è –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏' : '‚è∏Ô∏è –ü–∞—É–∑–∞';
}

function forceSync() {
    saveToLocalStorage();
    syncInfo.textContent = "–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ";
}

function hideTargetForm() {
    document.getElementById('targetForm').style.display = 'none';
}
    </script>
</body>
</html>
