<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта Повітряних Цілей</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e6e6e6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: rgba(26, 26, 46, 0.95);
            padding: 20px;
            border-right: 2px solid #0d8bf2;
            overflow-y: auto;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            z-index: 1;
        }

        .header {
            background: linear-gradient(90deg, #0d8bf2 0%, #0456a8 100%);
            padding: 15px 25px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .control-panel {
            background: rgba(34, 40, 49, 0.95);
            padding: 15px;
            border-bottom: 2px solid #0d8bf2;
        }

        .tabs {
            display: flex;
            margin-bottom: 15px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 8px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: rgba(13, 139, 242, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            color: #e6e6e6;
            font-weight: 600;
        }

        .tab.active {
            background: #0d8bf2;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .tab:hover {
            background: #1a9bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #0d8bf2;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #e6e6e6;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 2px #0d8bf2;
        }

        button {
            background: linear-gradient(90deg, #0d8bf2 0%, #0456a8 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin-top: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background: linear-gradient(90deg, #1a9bff 0%, #0d6efd 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .targets-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(34, 40, 49, 0.8);
            border-radius: 8px;
            padding: 10px;
        }

        .target-item {
            background: rgba(13, 139, 242, 0.15);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #0d8bf2;
            transition: all 0.3s ease;
        }

        .target-item:hover {
            background: rgba(13, 139, 242, 0.25);
            transform: translateX(5px);
        }

        .target-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .target-name {
            font-weight: 700;
            color: #0d8bf2;
        }

        .target-type {
            background: rgba(13, 139, 242, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .target-details {
            font-size: 14px;
            color: #b8b8b8;
        }

        .target-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .target-actions button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(13, 139, 242, 0.15);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(13, 139, 242, 0.3);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #0d8bf2;
            margin: 8px 0;
        }

        .stat-label {
            font-size: 14px;
            color: #b8b8b8;
        }

        .status-bar {
            background: rgba(34, 40, 49, 0.95);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #0d8bf2;
            font-size: 14px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4caf50;
        }

        .status-indicator.offline {
            background: #f44336;
        }

        .icon-btn {
            width: auto;
            padding: 8px 12px;
            margin: 0 5px;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #0d8bf2;
                max-height: 400px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            .tabs {
                flex-direction: column;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .status-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        .leaflet-popup-content {
            color: #333;
            font-size: 14px;
        }

        /* Анимации */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Стилі для траєкторій */
        .trajectory-path {
            stroke-width: 1;
            stroke-opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('add-target')">Додати ціль</button>
                <button class="tab" onclick="switchTab('targets-list')">Список цілей</button>
                <button class="tab" onclick="switchTab('stats')">Статистика</button>
                <button class="tab" onclick="switchTab('settings')">Налаштування</button>
            </div>

            <div id="add-target" class="tab-content active">
                <div class="form-group">
                    <label for="targetName">Назва цілі:</label>
                    <input type="text" id="targetName" placeholder="Введіть назву цілі">
                </div>
                <div class="form-group">
                    <label for="targetType">Тип цілі:</label>
                    <select id="targetType">
                        <option value="дрон">Дрон</option>
                        <option value="ракета">Ракета</option>
                        <option value="винищувач">Винищувач</option>
                        <option value="бомба">Бомба</option>
                        <option value="корабль">Корабель</option>
                        <option value="вертоліт">Вертоліт</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="targetSpeed">Швидкість (км/год):</label>
                    <input type="number" id="targetSpeed" placeholder="Введіть швидкість" value="150">
                </div>
                <div class="form-group">
                    <label for="targetCourse">Курс (0-360°):</label>
                    <input type="number" id="targetCourse" placeholder="Введіть курс" value="0" min="0" max="360">
                </div>
                <button onclick="addTarget()"><i class="fas fa-plus"></i> Додати ціль</button>
                <button onclick="addRandomTarget()" style="background: linear-gradient(90deg, #ff6b6b 0%, #ee5a24 100%);">
                    <i class="fas fa-dice"></i> Додати випадкову ціль
                </button>
            </div>

            <div id="targets-list" class="tab-content">
                <div class="targets-list" id="targetsListContainer">
                    <!-- Список цілей буде тут -->
                </div>
            </div>

            <div id="stats" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Всього цілей</div>
                        <div class="stat-value" id="totalTargets">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Активних цілей</div>
                        <div class="stat-value" id="activeTargets">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Загальна відстань</div>
                        <div class="stat-value" id="totalDistance">0 км</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Макс. швидкість</div>
                        <div class="stat-value" id="maxSpeed">0 км/год</div>
                    </div>
                </div>
                <button onclick="exportData()" style="margin-top: 15px;">
                    <i class="fas fa-download"></i> Експорт даних
                </button>
                <button onclick="importData()" style="background: linear-gradient(90deg, #ff6b6b 0%, #ee5a24 100%);">
                    <i class="fas fa-upload"></i> Імпорт даних
                </button>
            </div>

            <div id="settings" class="tab-content">
                <div class="form-group">
                    <label for="simulationSpeed">Швидкість симуляції:</label>
                    <div class="speed-control">
                        <button class="speed-btn" onclick="changeSpeed(-1)">-</button>
                        <span id="speedValue">5x</span>
                        <button class="speed-btn" onclick="changeSpeed(1)">+</button>
                    </div>
                </div>
                <button onclick="toggleSimulation()" id="simulationBtn">
                    <i class="fas fa-play"></i> Почати симуляцію
                </button>
                <button onclick="clearAllTargets()" style="background: linear-gradient(90deg, #ff6b6b 0%, #c0392b 100%);">
                    <i class="fas fa-trash"></i> Очистити всі цілі
                </button>
                <button onclick="toggleTrajectories()" id="trajectoriesBtn">
                    <i class="fas fa-project-diagram"></i> Вимкнути траєкторії
                </button>
                <button onclick="centerMap()">
                    <i class="fas fa-crosshairs"></i> Центрувати карту
                </button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1><i class="fas fa-crosshairs"></i> Карта Повітряних Цілей</h1>
            </div>
            <div class="control-panel">
                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-indicator" id="statusIndicator"></div>
                        <span id="statusText">Підключено до Firebase</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-users"></i>
                        <span id="onlineUsers">Онлайн: 1</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-clock"></i>
                        <span id="updateTime">Оновлено: --:--:--</span>
                    </div>
                </div>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <input type="file" id="importFile" style="display: none;" accept=".json">

    <script>
        // Глобальні змінні
        let map;
        let targets = [];
        let markers = {};
        let polylines = {};
        let isSimulationRunning = false;
        let simulationSpeed = 5;
        let lastUpdateTime = 0;
        let targetHistory = {};
        let isOnline = false;
        let showTrajectories = true;

        // Ініціалізація Firebase
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "your-project-id.firebaseapp.com",
            databaseURL: "https://your-project-id-default-rtdb.firebaseio.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789000",
            appId: "your-app-id-here"
        };

        // Ініціалізація додатку
        function initApp() {
            initMap();
            loadTargetsFromLocalStorage();
            initFirebase();
            setupEventListeners();
            updateStats();
            updateStatus();
        }

        // Ініціалізація карти
        function initMap() {
            map = L.map('map').setView([50.4500, 30.5233], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

// Додаємо темну тему карти
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '© OpenStreetMap, © CartoDB',
    maxZoom: 19
}).addTo(map);
}

// Ініціалізація Firebase
function initFirebase() {
    try {
        firebase.initializeApp(firebaseConfig);
        isOnline = true;
        setupRealtimeListeners();
        console.log("Firebase initialized successfully");
    } catch (error) {
        console.log("Firebase initialization error, using offline mode:", error);
        isOnline = false;
    }
    updateStatus();
}

// Налаштування слухачів Firebase
function setupRealtimeListeners() {
    if (!isOnline) return;
    
    const db = firebase.database();
    const targetsRef = db.ref('targets');
    
    // Слухач змін цілей
    targetsRef.on('value', (snapshot) => {
        const firebaseTargets = snapshot.val() || [];
        if (shouldSyncWithFirebase(firebaseTargets)) {
            targets = Object.values(firebaseTargets);
            updateMap();
            saveTargetsToLocalStorage();
            updateStats();
        }
    });
    
    // Лічильник онлайн-користувачів
    const usersRef = db.ref('onlineUsers');
    const userRef = usersRef.push();
    userRef.set(true);
    userRef.onDisconnect().remove();
    
    usersRef.on('value', (snapshot) => {
        const userCount = snapshot.numChildren();
        document.getElementById('onlineUsers').textContent = `Онлайн: ${userCount}`;
    });
}

// Функції для роботи з цілями
function addTarget() {
    const name = document.getElementById('targetName').value.trim();
    const type = document.getElementById('targetType').value;
    const speed = parseInt(document.getElementById('targetSpeed').value);
    const course = parseInt(document.getElementById('targetCourse').value);
    
    if (!name) {
        alert('Будь ласка, введіть назву цілі');
        return;
    }
    
    const target = {
        id: Date.now().toString(),
        name: name,
        type: type,
        speed: speed,
        course: course,
        latitude: map.getCenter().lat,
        longitude: map.getCenter().lng,
        distance: 0,
        maxSpeed: speed,
        createdAt: Date.now()
    };
    
    targets.push(target);
    addTargetToMap(target);
    saveTargets();
    updateStats();
    
    // Очистити форму
    document.getElementById('targetName').value = '';
}

function addRandomTarget() {
    const types = ['дрон', 'ракета', 'винищувач', 'бомба', 'корабль', 'вертоліт'];
    const names = {
        'дрон': ['Shahed-136', 'Orlan-10', 'Bayraktar', 'Ланцюг'],
        'ракета': ['Іскандер', 'Калібр', 'Точка-У', 'Х-101'],
        'винищувач': ['Су-27', 'МиГ-29', 'F-16', 'F-35'],
        'бомба': ['ФАБ-250', 'ФАБ-500', 'КАБ-500'],
        'корабль': ['Москва', 'Адмірал', 'Фрегат'],
        'вертоліт': ['Ка-52', 'Мі-8', 'Мі-24', 'Apache']
    };
    
    const randomType = types[Math.floor(Math.random() * types.length)];
    const randomName = names[randomType][Math.floor(Math.random() * names[randomType].length)];
    
    const target = {
        id: Date.now().toString(),
        name: `${randomName}-${Math.floor(Math.random() * 1000)}`,
        type: randomType,
        speed: Math.floor(Math.random() * 500) + 100,
        course: Math.floor(Math.random() * 360),
        latitude: map.getCenter().lat + (Math.random() - 0.5) * 2,
        longitude: map.getCenter().lng + (Math.random() - 0.5) * 4,
        distance: 0,
        maxSpeed: 0,
        createdAt: Date.now()
    };
    
    targets.push(target);
    addTargetToMap(target);
    saveTargets();
    updateStats();
}

// ОНОВЛЕНА ФУНКЦІЯ: Використання PNG іконок
function getIconForType(type) {
    const iconUrls = {
        'дрон': 'icons/shahed.png',
        'ракета': 'icons/raketa.png',
        'винищувач': 'icons/aircraft.png',
        'бомба': 'icons/bomb.png',
        'корабль': 'icons/ship.png',
        'вертоліт': 'icons/helicopter.png'
    };
    
    return L.icon({
        iconUrl: iconUrls[type] || 'icons/marker.png',
        iconSize: [30, 30],
        iconAnchor: [15, 15],
        popupAnchor: [0, -15]
    });
}

function addTargetToMap(target) {
    if (markers[target.id]) {
        map.removeLayer(markers[target.id]);
    }
    
    const icon = getIconForType(target.type);
    const marker = L.marker([target.latitude, target.longitude], { icon: icon, rotationAngle: target.course })
        .addTo(map)
        .bindPopup(`
            <strong>${target.name}</strong><br>
            Тип: ${target.type}<br>
            Швидкість: ${target.speed} км/год<br>
            Курс: ${target.course}°<br>
            Відстань: ${(target.distance).toFixed(1)} км
        `);
    
    markers[target.id] = marker;
    
    // ОНОВЛЕНА ФУНКЦІЯ: Створення траєкторій з товщиною 1px
    if (showTrajectories && !polylines[target.id]) {
        polylines[target.id] = L.polyline([], {
            color: getColorForType(target.type),
            weight: 1, // Товщина 1 піксель
            opacity: 0.7
        }).addTo(map);
    }
    
    // Зберігаємо початкову позицію для траєкторії
    if (!targetHistory[target.id]) {
        targetHistory[target.id] = [];
    }
    targetHistory[target.id].push([target.latitude, target.longitude]);
    
    // ОНОВЛЕНА ЛОГІКА: Без обмеження довжини траєкторії
    if (polylines[target.id]) {
        polylines[target.id].setLatLngs(targetHistory[target.id]);
    }
}

function getColorForType(type) {
    const colors = {
        'дрон': '#ff6b6b',
        'ракета': '#feca57',
        'винищувач': '#48dbfb',
        'бомба': '#ff9ff3',
        'корабль': '#1dd1a1',
        'вертоліт': '#f368e0'
    };
    return colors[type] || '#ffffff';
}

function updateTargetOnMap(target) {
    if (markers[target.id]) {
        markers[target.id].setLatLng([target.latitude, target.longitude]);
        markers[target.id].setRotationAngle(target.course);
        markers[target.id].setPopupContent(`
            <strong>${target.name}</strong><br>
            Тип: ${target.type}<br>
            Швидкість: ${target.speed} км/год<br>
            Курс: ${target.course}°<br>
            Відстань: ${(target.distance).toFixed(1)} км
        `);
        
        // ОНОВЛЕНА ЛОГІКА: Оновлення траєкторії без обмежень довжини
        targetHistory[target.id].push([target.latitude, target.longitude]);
        if (polylines[target.id]) {
            polylines[target.id].setLatLngs(targetHistory[target.id]);
        }
    }
}

function calculateNewPosition(target, deltaTime) {
    const R = 6371; // Радіус Землі в км
    const distanceKm = (target.speed * deltaTime) / 3600; // Відстань у км
    
    const lat1 = target.latitude * Math.PI / 180;
    const lon1 = target.longitude * Math.PI / 180;
    const courseRad = target.course * Math.PI / 180;
    
    const lat2 = Math.asin(Math.sin(lat1) * Math.cos(distanceKm/R) +
                         Math.cos(lat1) * Math.sin(distanceKm/R) * Math.cos(courseRad));
    
    const lon2 = lon1 + Math.atan2(Math.sin(courseRad) * Math.sin(distanceKm/R) * Math.cos(lat1),
                                 Math.cos(distanceKm/R) - Math.sin(lat1) * Math.sin(lat2));
    
    return {
        latitude: lat2 * 180 / Math.PI,
        longitude: lon2 * 180 / Math.PI
    };
}

function moveTargets() {
    const now = Date.now();
    const deltaTime = lastUpdateTime ? (now - lastUpdateTime) * simulationSpeed : 0;
    lastUpdateTime = now;
    
    if (deltaTime === 0) return;
    
    let totalDistance = 0;
    let maxSpeed = 0;
    let activeCount = 0;
    
    targets.forEach(target => {
        const newPos = calculateNewPosition(target, deltaTime);
        const distanceThisFrame = calculateDistance(
            target.latitude, target.longitude,
            newPos.latitude, newPos.longitude
        );
        
        target.latitude = newPos.latitude;
        target.longitude = newPos.longitude;
        target.distance += distanceThisFrame;
        target.maxSpeed = Math.max(target.maxSpeed, target.speed);
        
        totalDistance += target.distance;
        maxSpeed = Math.max(maxSpeed, target.speed);
        activeCount++;
        
        updateTargetOnMap(target);
    });
    
    document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(1)} км`;
    document.getElementById('maxSpeed').textContent = `${maxSpeed} км/год`;
    document.getElementById('activeTargets').textContent = activeCount;
    
    if (isSimulationRunning) {
        requestAnimationFrame(moveTargets);
    }
}

function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Система збереження даних
function saveTargets() {
    saveTargetsToLocalStorage();
    if (isOnline) {
        syncWithFirebase();
    }
}

function saveTargetsToLocalStorage() {
    localStorage.setItem('airTargets', JSON.stringify(targets));
    localStorage.setItem('targetHistory', JSON.stringify(targetHistory));
    localStorage.setItem('simulationSpeed', simulationSpeed.toString());
    localStorage.setItem('showTrajectories', showTrajectories.toString());
}

function loadTargetsFromLocalStorage() {
    const savedTargets = localStorage.getItem('airTargets');
    const savedHistory = localStorage.getItem('targetHistory');
    const savedSpeed = localStorage.getItem('simulationSpeed');
    const savedTrajectories = localStorage.getItem('showTrajectories');
    
    if (savedTargets) {
        targets = JSON.parse(savedTargets);
    } else {
        // Тестові дані
        targets = [
            {
                id: '1',
                name: 'Shahed-136',
                type: 'дрон',
                speed: 150,
                course: 45,
                latitude: 50.45,
                longitude: 30.52,
                distance: 0,
                maxSpeed: 150,
                createdAt: Date.now()
            },
            {
                id: '2',
                name: 'Іскандер',
                type: 'ракета',
                speed: 300,
                course: 90,
                latitude: 49.0,
                longitude: 32.0,
                distance: 0,
                maxSpeed: 300,
                createdAt: Date.now()
            }
        ];
    }
    
    if (savedHistory) {
        targetHistory = JSON.parse(savedHistory);
    }
    
    if (savedSpeed) {
        simulationSpeed = parseInt(savedSpeed);
        document.getElementById('speedValue').textContent = `${simulationSpeed}x`;
    }
    
    if (savedTrajectories) {
        showTrajectories = savedTrajectories === 'true';
        updateTrajectoriesButton();
    }
    
    updateMap();
}

function syncWithFirebase() {
    if (!isOnline) return;
    
    const db = firebase.database();
    const targetsRef = db.ref('targets');
    
    const targetsDict = {};
    targets.forEach(target => {
        targetsDict[target.id] = target;
    });
    
    targetsRef.set(targetsDict);
}

function shouldSyncWithFirebase(firebaseTargets) {
    if (Object.keys(firebaseTargets).length === 0) return false;
    if (targets.length === 0) return true;
    
    const localLastUpdate = Math.max(...targets.map(t => t.updatedAt || t.createdAt));
    const remoteLastUpdate = Math.max(...Object.values(firebaseTargets).map(t => t.updatedAt || t.createdAt));
    
    return remoteLastUpdate > localLastUpdate;
}

// Управління симуляцією
function toggleSimulation() {
    isSimulationRunning = !isSimulationRunning;
    
    if (isSimulationRunning) {
        document.getElementById('simulationBtn').innerHTML = '<i class="fas fa-pause"></i> Пауза';
        lastUpdateTime = Date.now();
        moveTargets();
    } else {
        document.getElementById('simulationBtn').innerHTML = '<i class="fas fa-play"></i> Почати симуляцію';
    }
}

function changeSpeed(delta) {
    simulationSpeed = Math.max(1, Math.min(10, simulationSpeed + delta));
    document.getElementById('speedValue').textContent = `${simulationSpeed}x`;
    saveTargetsToLocalStorage();
}

function toggleTrajectories() {
    showTrajectories = !showTrajectories;
    
    // Оновлюємо всі траєкторії
    Object.keys(polylines).forEach(id => {
        if (polylines[id]) {
            if (showTrajectories) {
                map.addLayer(polylines[id]);
            } else {
                map.removeLayer(polylines[id]);
            }
        }
    });
    
    updateTrajectoriesButton();
    saveTargetsToLocalStorage();
}

function updateTrajectoriesButton() {
    const btn = document.getElementById('trajectoriesBtn');
    if (showTrajectories) {
        btn.innerHTML = '<i class="fas fa-project-diagram"></i> Вимкнути траєкторії';
    } else {
        btn.innerHTML = '<i class="fas fa-project-diagram"></i> Увімкнути траєкторії';
    }
}

function clearAllTargets() {
    if (!confirm('Ви впевнені, що хочете видалити всі цілі?')) return;
    
    // Видаляємо маркери
    Object.values(markers).forEach(marker => map.removeLayer(marker));
    Object.values(polylines).forEach(polyline => map.removeLayer(polyline));
    
    targets = [];
    markers = {};
    polylines = {};
    targetHistory = {};
    
    saveTargets();
    updateStats();
    updateTargetsList();
}

function centerMap() {
    if (targets.length > 0) {
        const group = new L.featureGroup(Object.values(markers));
        map.fitBounds(group.getBounds());
    } else {
        map.setView([50.4500, 30.5233], 6);
    }
}

// Оновлення інтерфейсу
function updateMap() {
    // Видаляємо старі маркери
    Object.values(markers).forEach(marker => map.removeLayer(marker));
    Object.values(polylines).forEach(polyline => map.removeLayer(polyline));
    
    markers = {};
    polylines = {};
    
    // Додаємо нові маркери
    targets.forEach(target => {
        addTargetToMap(target);
    });
}

function updateStats() {
    document.getElementById('totalTargets').textContent = targets.length;
    document.getElementById('activeTargets').textContent = targets.length;
    
    const totalDistance = targets.reduce((sum, target) => sum + target.distance, 0);
    const maxSpeed = targets.reduce((max, target) => Math.max(max, target.speed), 0);

        document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(1)} км`;
document.getElementById('maxSpeed').textContent = `${maxSpeed} км/год`;
}

function updateTargetsList() {
const container = document.getElementById('targetsListContainer');
container.innerHTML = '';

targets.forEach(target => {
    const targetElement = document.createElement('div');
    targetElement.className = 'target-item';
    targetElement.innerHTML = `
        <div class="target-header">
            <span class="target-name">${target.name}</span>
            <span class="target-type">${target.type}</span>
        </div>
        <div class="target-details">
            Швидкість: ${target.speed} км/год<br>
            Курс: ${target.course}°<br>
            Відстань: ${target.distance.toFixed(1)} км
        </div>
        <div class="target-actions">
            <button onclick="editTarget('${target.id}')"><i class="fas fa-edit"></i></button>
            <button onclick="deleteTarget('${target.id}')" style="background: linear-gradient(90deg, #ff6b6b 0%, #ee5a24 100%);">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(targetElement);
});
}

function editTarget(id) {
const target = targets.find(t => t.id === id);
if (!target) return;

// Заповнюємо форму даними цілі
document.getElementById('targetName').value = target.name;
document.getElementById('targetType').value = target.type;
document.getElementById('targetSpeed').value = target.speed;
document.getElementById('targetCourse').value = target.course;

// Видаляємо стару ціль
deleteTarget(id);

// Переходимо на вкладку додавання
switchTab('add-target');
}

function deleteTarget(id) {
if (!confirm('Видалити цю ціль?')) return;

// Видаляємо з масиву
targets = targets.filter(t => t.id !== id);

// Видаляємо маркер
if (markers[id]) {
    map.removeLayer(markers[id]);
    delete markers[id];
}

// Видаляємо траєкторію
if (polylines[id]) {
    map.removeLayer(polylines[id]);
    delete polylines[id];
}

// Видаляємо історію
delete targetHistory[id];

saveTargets();
updateStats();
updateTargetsList();
}

function switchTab(tabName) {
// Приховуємо всі вкладки
document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
});

// Деактивуємо всі кнопки вкладок
document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
});

// Показуємо обрану вкладку
document.getElementById(tabName).classList.add('active');

// Активуємо обрану кнопку
document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

// Оновлюємо список цілей при переході на відповідну вкладку
if (tabName === 'targets-list') {
    updateTargetsList();
}
}

function exportData() {
const data = {
    targets: targets,
    exportDate: new Date().toISOString(),
    version: '2.5'
};

const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
const url = URL.createObjectURL(blob);

const a = document.createElement('a');
a.href = url;
a.download = `air-targets-export-${new Date().toISOString().split('T')[0]}.json`;
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}

function importData() {
document.getElementById('importFile').click();
}

function handleFileImport(event) {
const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();
reader.onload = function(e) {
    try {
        const data = JSON.parse(e.target.result);
        
        if (data.targets && Array.isArray(data.targets)) {
            // Видаляємо поточні цілі
            clearAllTargets();
            
            // Додаємо імпортовані цілі
            targets = data.targets;
            updateMap();
            saveTargets();
            updateStats();
            updateTargetsList();
            
            alert(`Успішно імпортовано ${targets.length} цілей`);
        } else {
            throw new Error('Невірний формат файлу');
        }
    } catch (error) {
        alert('Помилка при імпорті даних: ' + error.message);
    }
};
reader.readAsText(file);

// Очищаємо input для можливості повторного вибору того ж файлу
event.target.value = '';
}

function updateStatus() {
const indicator = document.getElementById('statusIndicator');
const statusText = document.getElementById('statusText');
const updateTime = document.getElementById('updateTime');

if (isOnline) {
    indicator.className = 'status-indicator';
    statusText.textContent = 'Підключено до Firebase';
} else {
    indicator.className = 'status-indicator offline';
    statusText.textContent = 'Автономний режим';
}

updateTime.textContent = `Оновлено: ${new Date().toLocaleTimeString()}`;
}

function setupEventListeners() {
// Обробник імпорту файлів
document.getElementById('importFile').addEventListener('change', handleFileImport);

// Гарячі клавіші
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        centerMap();
    }
    if (e.key === ' ' && !e.target.tagName.toLowerCase().match(/input|textarea/)) {
        e.preventDefault();
        toggleSimulation();
    }
});

// Оновлення часу кожну хвилину
setInterval(updateStatus, 60000);
}

// Утиліти
function shouldSyncWithFirebase(firebaseTargets) {
if (Object.keys(firebaseTargets).length === 0) return false;
if (targets.length === 0) return true;

const localLastUpdate = Math.max(...targets.map(t => t.updatedAt || t.createdAt));
const remoteLastUpdate = Math.max(...Object.values(firebaseTargets).map(t => t.updatedAt || t.createdAt));

return remoteLastUpdate > localLastUpdate;
}

// Ініціалізація при завантаженні
document.addEventListener('DOMContentLoaded', function() {
initApp();

// Оновлюємо стан кнопки траєкторій
updateTrajectoriesButton();

// Встановлюємо початкову швидкість
document.getElementById('speedValue').textContent = `${simulationSpeed}x`;
});

// Обробник помилок
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
});

// Додаємо обробник для закриття Firebase з'єднання при закритті сторінки
window.addEventListener('beforeunload', function() {
    if (isOnline) {
        const db = firebase.database();
        const usersRef = db.ref('onlineUsers');
        // Тут має бути логіка для видалення поточного користувача
    }
});
</script>

<!-- Додаємо скрипти для Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</body>
</html>
