<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта повітряних цілей</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #3498db;
            --fighter: #3498db;
            --drone: #e74c3c;
            --rocket: #f39c12;
            --bomb: #95a5a6;
            --ship: #9b59b6;
            --helicopter: #2ecc71;
            --transport: #f1c40f;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark-bg: linear-gradient(135deg, #1a1f2d 0%, #2c3e50 100%);
            --card-bg: #2c3e50;
            --border: #a38d6d;
            --text: #ecf0f1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            padding: 20px; 
            background: var(--dark-bg); 
            color: var(--text); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 28px;
            background: linear-gradient(45deg, var(--primary), var(--helicopter));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #map { 
            height: 700px; 
            width: 100%; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .btn {
            padding: 12px 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .btn i { font-size: 16px; }

        .btn-danger { background: var(--danger); }
        .btn-danger:hover { box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4); }

        .btn-success { background: var(--success); }
        .btn-success:hover { box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4); }

        .btn-warning { background: var(--warning); }
        .btn-warning:hover { box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4); }

        .controls {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .stat-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        /* Модальные окна */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 2px solid var(--border);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(26, 31, 45, 0.8);
            color: var(--text);
            transition: all 0.3s ease;
        }

        .modal input:focus, .modal select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        /* Стили для целей */
        .targets-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .targets-container {
                grid-template-columns: 1fr;
            }
        }

        .targets-section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .target-item {
            padding: 15px;
            margin: 8px 0;
            background: rgba(52, 73, 94, 0.6);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }

        .target-item:hover {
            background: rgba(52, 73, 94, 0.9);
            transform: translateX(5px);
        }

        .target-item.selected {
            background: rgba(41, 128, 185, 0.3);
            border-left-color: var(--success);
        }

        .target-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }

        .type-fighter { background: var(--fighter); }
        .type-drone { background: var(--drone); }
        .type-rocket { background: var(--rocket); }
        .type-bomb { background: var(--bomb); }
        .type-ship { background: var(--ship); }
        .type-helicopter { background: var(--helicopter); }
        .type-transport { background: var(--transport); }

        /* Треугольные маркеры */
        .triangle-icon {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid;
        }

        /* Поиск */
        .search-container { 
            margin: 15px 0; 
            position: relative;
            max-width: 400px;
        }

        #searchInput { 
            width: 100%; 
            padding: 12px 45px 12px 15px;
            border: 1px solid var(--border); 
            border-radius: 25px; 
            background: var(--card-bg); 
            color: var(--text);
            transition: all 0.3s ease;
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
        }

        #searchResults { 
            position: absolute; 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            max-height: 250px; 
            overflow-y: auto; 
            width: 100%; 
            display: none; 
            z-index: 1000;
            border-radius: 0 0 8px 8px;
            top: 100%;
        }

        .search-result { 
            padding: 12px; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .search-result:hover { 
            background: rgba(52, 152, 219, 0.2);
        }

        /* Скрытые маркеры */
        .target-icon.hidden {
            opacity: 0.4;
            filter: grayscale(0.8);
        }

        /* Статус бар */
        .status-bar {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: var(--card-bg);
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid var(--border);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Уведомления */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: var(--card-bg);
            color: white;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-left-color: var(--success); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Контекстное меню */
        .context-menu {
            position: fixed;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 0;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .context-menu-item:hover {
            background: rgba(52, 152, 219, 0.2);
        }

        /* Групповое управление */
        .group-controls {
            display: none;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--warning);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            body { padding: 10px; }
            #map { height: 400px; }
            .controls { flex-direction: column; }
            .btn { width: 100%; margin: 5px 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .status-bar { 
                bottom: 10px;
                right: 10px;
                left: 10px;
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Анимации */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Прогресс бар */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 5px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-radar fa-2x" style="color: var(--primary);"></i>
                <h1>Система відстеження повітряних цілей</h1>
            </div>
            <div class="header-controls">
                <button class="btn" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i>Довідка
                </button>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-crosshairs"></i> Всього цілей</h3>
                <div class="stat-value" id="totalTargets">0</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-eye"></i> Видимі цілі</h3>
                <div class="stat-value" id="visibleTargets">0</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-tachometer-alt"></i> Середня швидкість</h3>
                <div class="stat-value" id="avgSpeed">0 км/год</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-clock"></i> Час роботи</h3>
                <div class="stat-value" id="uptime">00:00:00</div>
            </div>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Пошук населеного пункту...">
            <i class="fas fa-search search-icon"></i>
            <div id="searchResults"></div>
        </div>

        <div class="controls">
            <button class="btn" onclick="centerMap()">
                <i class="fas fa-crosshairs"></i>Центрувати
            </button>
            <button class="btn" onclick="toggleAddMode()" id="addModeBtn">
                <i class="fas fa-plus"></i>Додати ціль
            </button>
            <button class="btn" onclick="togglePause()" id="pauseBtn">
                <i class="fas fa-pause"></i>Пауза
            </button>
            <button class="btn" onclick="toggleTrails()" id="trailsBtn">
                <i class="fas fa-route"></i>Траєкторії
            </button>
            <button class="btn" onclick="toggleMapView()" id="mapViewBtn">
                <i class="fas fa-satellite"></i>Супутник
            </button>
            <button class="btn" onclick="showAllTargets()">
                <i class="fas fa-eye"></i>Показати всі
            </button>
            <button class="btn btn-warning" onclick="showGroupControls()">
                <i class="fas fa-object-group"></i>Групове керування
            </button>
            <button class="btn btn-danger" onclick="clearAllTargets()">
                <i class="fas fa-trash"></i>Очистити всі
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <i class="fas fa-download"></i>Експорт
            </button>
        </div>

        <div class="group-controls" id="groupControls">
            <h3><i class="fas fa-object-group"></i> Групове керування</h3>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <input type="number" id="groupSpeed" placeholder="Швидкість" class="modal-input">
                <input type="number" id="groupCourse" placeholder="Курс" min="0" max="360" class="modal-input">
                <button class="btn btn-success" onclick="applyGroupSettings()">
                    <i class="fas fa-check"></i>Застосувати
                </button>
            </div>
            <div id="selectedCount">Вибрані цілі: 0</div>
        </div>

        <div id="map"></div>

        <div class="targets-container">
            <div class="targets-section">
                <h3><i class="fas fa-list"></i> Активні цілі</h3>
                <div id="targetsList">Завантаження...</div>
            </div>
            
            <div class="targets-section">
                <h3><i class="fas fa-chart-line"></i> Статистика руху</h3>
                <div id="targetsStats">
                    <p>Оберіть ціль для перегляду статистики</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Форма добавления/редактирования цели -->
    <div id="targetForm" class="modal">
        <div class="modal-content">
            <h3 id="formTitle"><i class="fas fa-plus"></i> Додати ціль</h3>
            <input type="hidden" id="targetId">
            
            <input type="text" id="targetName" placeholder="Назва цілі" class="modal-input">
            <input type="number" id="targetSpeed" placeholder="Швидкість (км/год)" min="0" max="5000" class="modal-input">
            <input type="number" id="targetCourse" placeholder="Курс (0-360°)" min="0" max="360" class="modal-input">
            
            <select id="targetType" class="modal-input">
                <option value="винищувач">🛩️ Винищувач</option>
                <option value="дрон">🚁 Дрон (Shahed)</option>
                <option value="ракета">🚀 Ракета</option>
                <option value="бомба">💣 Бомба</option>
                <option value="корабль">🚢 Корабель</option>
                <option value="вертоліт">🚁 Вертоліт</option>
                <option value="транспорт">✈️ Транспортний літак</option>
            </select>

            <div style="margin-top:20px; display: flex; gap: 10px; justify-content: space-between;">
                <button class="btn btn-success" onclick="saveTarget()">
                    <i class="fas fa-save"></i>Зберегти
                </button>
                <button class="btn btn-danger" onclick="deleteTarget()" id="deleteBtn">
                    <i class="fas fa-trash"></i>Видалити
                </button>
                <button class="btn" onclick="hideTargetForm()">
                    <i class="fas fa-times"></i>Скасувати
                </button>
            </div>
        </div>
    </div>

    <!-- Контекстное меню -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextEdit()">
            <i class="fas fa-edit"></i> Редагувати
        </div>
        <div class="context-menu-item" onclick="contextChangeCourse()">
            <i class="fas fa-compass"></i> Змінити курс
        </div>
        <div class="context-menu-item" onclick="contextDelete()">
            <i class="fas fa-trash"></i> Видалити
        </div>
    </div>

    <!-- Статус бар -->
    <div class="status-bar" id="statusBar">
        <div class="status-item">
            <i class="fas fa-circle" style="color: var(--success);"></i>
            <span>Статус: Активний</span>
        </div>
        <div class="status-item">
            <i class="fas fa-crosshairs"></i>
            <span>Цілей: <span id="statusTargets">0</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-clock"></i>
            <span>Час: <span id="statusTime">00:00:00</span></span>
        </div>
    </div>

    <!-- Контейнер для уведомлений -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Скрытый input для импорта -->
    <input type="file" id="importFile" accept=".json" style="display:none">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Глобальные переменные
        let map;
        let markers = {};
        let animationPaused = false;
        let courseMode = false;
        let addMode = false;
        let trailsVisible = true;
        let selectedTargetId = null;
        let currentMapView = 'street';
        let baseLayers = {};
        let targets = [];
        let animationInterval;
        let targetTrails = {};
        let targetHistory = {};
        let clickMarker = null;
        let lastFrameTime = performance.now();
        let hiddenTargets = new Set();
        let nextId = 1;
        let selectedTargets = new Set();
        let startTime = Date.now();
        let contextMenuTarget = null;

        // Инициализация карты
        function initMap() {
            console.log("Инициализация карты...");
            map = L.map('map').setView([50.4501, 30.5234], 6);

            // Слои карты
            baseLayers.street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });

            baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 19
            });

            baseLayers.street.addTo(map);

            // Инициализация поиска
            initSearch();

            // Обработчики событий
            map.on('click', handleMapClick);
            map.on('moveend', updateVisibleTargets);
            map.on('contextmenu', handleContextMenu);

            // Горячие клавиши
            initHotkeys();

            // Загрузка данных
            loadTargets();
            startAnimation();
            updateStats();
            startUptimeCounter();

            showToast('Система ініціалізована успішно!', 'success');
        }

        // Обработчик кликов по карте
        function handleMapClick(e) {
            if (addMode) {
                handleAddClick(e);
            } else if (courseMode && selectedTargetId !== null) {
                updateTargetCourse(e);
            }
        }

        // Обработчик контекстного меню
        function handleContextMenu(e) {
            e.originalEvent.preventDefault();
            hideContextMenu();
        }

        // Горячие клавиши
        function initHotkeys() {
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT') return;

                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        togglePause();
                        break;
                    case 'KeyC':
                        if (e.ctrlKey) centerMap();
                        break;
                    case 'Delete':
                        if (selectedTargets.size > 0) {
                            deleteSelectedTargets();
                        }
                        break;
                    case 'Escape':
                        hideContextMenu();
                        hideTargetForm();
                        selectedTargets.clear();
                        updateGroupControls();
                        break;
                }
            });
        }

        // Показать уведомление
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation' : 'info'}-circle"></i>
                ${message}
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Контекстное меню
        function showContextMenu(e, targetId) {
            e.preventDefault();
            contextMenuTarget = targetId;
            
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextMenuTarget = null;
        }

        function contextEdit() {
            if (contextMenuTarget) {
                showTargetForm(contextMenuTarget);
            }
            hideContextMenu();
        }

        function contextChangeCourse() {
            if (contextMenuTarget) {
                selectTargetForCourse(contextMenuTarget);
            }
            hideContextMenu();
        }

        function contextDelete() {
            if (contextMenuTarget) {
                const target = targets.find(t => t.id === contextMenuTarget);
                if (target && confirm(`Видалити ціль "${target.name}"?`)) {
                    deleteTargetById(contextMenuTarget);
                }
            }
            hideContextMenu();
        }

        // Групповое управление
        function showGroupControls() {
            document.getElementById('groupControls').style.display = 
                document.getElementById('groupControls').style.display === 'block' ? 'none' : 'block';
        }

        function updateGroupControls() {
            const count = selectedTargets.size;
            document.getElementById('selectedCount').textContent = `Вибрані цілі: ${count}`;
            document.getElementById('groupControls').style.display = count > 0 ? 'block' : 'none';
        }

        function applyGroupSettings() {
            const speed = parseFloat(document.getElementById('groupSpeed').value);
            const course = parseFloat(document.getElementById('groupCourse').value);
            
            if (isNaN(speed) && isNaN(course)) {
                showToast('Введіть швидкість або курс', 'warning');
                return;
            }

            selectedTargets.forEach(id => {
                const target = targets.find(t => t.id === id);
                if (target) {
                    if (!isNaN(speed)) target.speed = speed;
                    if (!isNaN(course)) target.course = course;
                }
            });

            updateMapMarkers();
            updateTargetsList();
            showToast(`Оновлено ${selectedTargets.size} цілей`, 'success');
        }

        // Остальные функции (loadTargets, saveTargetsToStorage, updateStats, и т.д.)
        // ... [Здесь должен быть остальной код из предыдущей версии] ...

        // Добавляем обновление статистики в moveTargets
        function moveTargets() {
            if (animationPaused) return;

            const now = performance.now();
            const deltaTime = (now - lastFrameTime) / 1000;
            lastFrameTime = now;

            targets.forEach(target => {
                // ... [код движения] ...
            });

            updateStats(); // Обновляем статистику
        }

        // Обновление статистики
        function updateStats() {
            document.getElementById('totalTargets').textContent = targets.length;
            document.getElementById('visibleTargets').textContent = targets.length - hiddenTargets.size;
            
            const avgSpeed = targets.reduce((sum, target) => sum + target.speed, 0) / (targets.length || 1);
            document.getElementById('avgSpeed').textContent = `${Math.round(avgSpeed)} км/год`;
            
            document.getElementById('statusTargets').textContent = targets.length;
        }

        // Счетчик времени работы
        function startUptimeCounter() {
            setInterval(() => {
                const seconds = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                document.getElementById('uptime').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                document.getElementById('statusTime').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        }

        // Помощь
        function showHelp() {
            alert(`Гарячі клавиші:\n\nSpace - Пауза/Відтворити\nDelete - Видалити вибрані\nCtrl+C - Центрувати карту\nEscape - Скасувати\n\nКлавіша миши - Контекстне меню`);
        }

        // Запуск при загрузке
        window.onload = initMap;

        // Закрытие контекстного меню при клике вне его
        document.addEventListener('click', hideContextMenu);
    </script>
</body>
</html>
