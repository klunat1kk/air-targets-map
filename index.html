<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта повітряних цілей</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
    <style>
        body { margin: 0; padding: 0; height: 100vh; width: 100%; font-family: 'Arial', sans-serif; background: #f0f2f5; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .sidebar { position: fixed; top: 0; right: -400px; width: 400px; height: 100vh; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 1000; transition: right 0.3s ease; padding: 20px; overflow-y: auto; }
        .sidebar.open { right: 0; }
        .toggle-sidebar { position: fixed; top: 20px; right: 20px; z-index: 1001; background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .target-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; margin-bottom: 15px; }
        .target-card h5 { color: #495057; margin-bottom: 10px; }
        .target-card p { margin: 5px 0; color: #6c757d; }
        .control-panel { position: fixed; bottom: 20px; left: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .control-panel h4 { margin: 0 0 15px 0; color: #495057; }
        .control-panel label { display: block; margin: 10px 0 5px 0; color: #495057; }
        .control-panel input { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; margin-bottom: 10px; }
        .control-panel button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .control-panel button:hover { background: #0056b3; }
        .info-panel { position: fixed; top: 20px; left: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .info-panel h4 { margin: 0 0 10px 0; color: #495057; }
        .info-panel p { margin: 5px 0; color: #6c757d; }
        .target-marker { background: transparent; border: none; }
        .target-marker div { font-size: 20px; color: #dc3545; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .course-line { stroke: #007bff; stroke-width: 2; stroke-dasharray: 5,5; }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 5px; color: white; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        .notification.success { background: #28a745; opacity: 1; }
        .notification.error { background: #dc3545; opacity: 1; }
        .notification.warning { background: #ffc107; color: #212529; opacity: 1; }
        .map-legend { position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .legend-color { width: 20px; height: 20px; margin-right: 10px; border-radius: 3px; }
        .legend-text { font-size: 14px; color: #495057; }
        .admin-badge { position: fixed; top: 10px; right: 10px; background: #dc3545; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; z-index: 1001; }
        .target-filter { position: fixed; top: 70px; left: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .filter-item { margin: 5px 0; }
        .timestamp { font-size: 12px; color: #6c757d; margin-top: 10px; }
        .weather-overlay { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1500; display: none; }
        .weather-content { text-align: center; }
        .weather-icon { font-size: 48px; margin-bottom: 10px; }
        .close-weather { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer; }
        .target-history { margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .history-item { font-size: 12px; color: #6c757d; margin: 2px 0; }
        .export-buttons { margin-top: 15px; }
        .export-btn { background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .export-btn:hover { background: #218838; }
        .import-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .speed-gauge { width: 100px; height: 100px; position: relative; margin: 10px auto; }
        .gauge-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 16px; font-weight: bold; color: #007bff; }
        .altitude-chart { width: 100%; height: 100px; margin: 10px 0; }
        .course-indicator { width: 30px; height: 30px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin: 0 auto; }
        .target-properties { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; }
        .property-item { background: #e9ecef; padding: 8px; border-radius: 4px; text-align: center; }
        .property-label { font-size: 12px; color: #6c757d; }
        .property-value { font-size: 16px; font-weight: bold; color: #495057; }
        .simulation-controls { margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .sim-btn { background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .sim-btn:hover { background: #5a359c; }
        .time-control { display: flex; align-items: center; margin: 10px 0; }
        .time-slider { flex: 1; margin: 0 10px; }
        .time-display { font-size: 14px; color: #495057; min-width: 80px; }
        .target-groups { margin-top: 15px; }
        .group-item { background: #e9ecef; padding: 8px; border-radius: 4px; margin: 5px 0; cursor: pointer; }
        .group-item:hover { background: #dee2e6; }
        .group-item.active { background: #007bff; color: white; }
        .analytics-panel { margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6; }
        .metric-item { display: flex; justify-content: space-between; margin: 5px 0; }
        .metric-label { color: #6c757d; }
        .metric-value { font-weight: bold; color: #495057; }
        .alert-system { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: #dc3545; color: white; padding: 10px 20px; border-radius: 5px; z-index: 2000; display: none; }
        .alert-content { text-align: center; }
        .alert-close { position: absolute; top: 5px; right: 10px; background: none; border: none; color: white; font-size: 16px; cursor: pointer; }
        .target-timeline { width: 100%; height: 60px; background: #f8f9fa; border-radius: 4px; margin: 10px 0; position: relative; }
        .timeline-marker { position: absolute; top: 0; width: 2px; height: 100%; background: #007bff; }
        .timeline-label { position: absolute; top: -20px; font-size: 10px; color: #6c757d; }
        .export-format { margin: 5px 0; }
        .format-btn { background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px; font-size: 12px; }
        .format-btn:hover { background: #138496; }
        .import-file { margin: 10px 0; }
        .file-input { width: 100%; padding: 5px; border: 1px solid #ced4da; border-radius: 4px; }
        .import-btn { background: #fd7e14; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .import-btn:hover { background: #e66a00; }
        .validation-error { color: #dc3545; font-size: 12px; margin-top: 5px; display: none; }
        .help-tooltip { position: relative; display: inline-block; margin-left: 5px; }
        .tooltip-icon { color: #6c757d; cursor: help; }
        .tooltip-text { visibility: hidden; width: 200px; background: #333; color: white; text-align: center; border-radius: 6px; padding: 5px; position: absolute; z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; }
        .help-tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .target-actions { display: flex; gap: 5px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 5px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .action-track { background: #17a2b8; color: white; }
        .action-lock { background: #6f42c1; color: white; }
        .action-delete { background: #dc3545; color: white; }
        .target-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin: 10px 0; }
        .stat-item { text-align: center; padding: 5px; background: #e9ecef; border-radius: 3px; }
        .stat-value { font-size: 14px; font-weight: bold; }
        .stat-label { font-size: 10px; color: #6c757d; }
        .simulation-status { margin-top: 10px; padding: 5px; background: #f8f9fa; border-radius: 3px; text-align: center; font-size: 12px; }
        .status-running { color: #28a745; }
        .status-paused { color: #ffc107; }
        .status-stopped { color: #dc3545; }
        .target-prediction { margin-top: 10px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; }
        .prediction-title { font-weight: bold; color: #856404; margin-bottom: 5px; }
        .prediction-item { font-size: 12px; color: #856404; margin: 2px 0; }
        .weather-impact { margin-top: 10px; padding: 10px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; }
        .impact-title { font-weight: bold; color: #0c5460; margin-bottom: 5px; }
        .impact-item { font-size: 12px; color: #0c5460; margin: 2px 0; }
        .target-classification { margin-top: 10px; }
        .class-badge { display: inline-block; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; margin-right: 5px; }
        .class-friendly { background: #28a745; color: white; }
        .class-hostile { background: #dc3545; color: white; }
        .class-unknown { background: #6c757d; color: white; }
        .target-priority { margin-top: 5px; }
        .priority-high { color: #dc3545; font-weight: bold; }
        .priority-medium { color: #ffc107; font-weight: bold; }
        .priority-low { color: #28a745; font-weight: bold; }
        .target-sensor { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .sensor-title { font-weight: bold; color: #495057; margin-bottom: 5px; }
        .sensor-data { font-size: 12px; color: #6c757d; }
        .target-threat { margin-top: 10px; }
        .threat-level { height: 10px; background: #28a745; border-radius: 5px; margin: 5px 0; }
        .threat-high { background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%); }
        .threat-medium { background: linear-gradient(90deg, #28a745 0%, #ffc107 100%); }
        .threat-low { background: #28a745; }
        .target-countermeasures { margin-top: 10px; }
        .cm-item { font-size: 12px; color: #6c757d; margin: 2px 0; }
        .target-communications { margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px; }
        .comm-title { font-weight: bold; color: #495057; margin-bottom: 5px; }
        .comm-status { font-size: 12px; color: #28a745; }
        .comm-offline { color: #dc3545; }
        .target-nav { margin-top: 10px; }
        .nav-item { font-size: 12px; color: #6c757d; margin: 2px 0; }
        .target-debug { margin-top: 10px; padding: 10px; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; display: none; }
        .debug-title { font-weight: bold; color: #721c24; margin-bottom: 5px; }
        .debug-item { font-size: 10px; color: #721c24; margin: 1px 0; }
        .target-3dview { margin-top: 10px; height: 100px; background: #000; border-radius: 4px; position: relative; overflow: hidden; }
        .view-axis { position: absolute; width: 2px; background: #007bff; }
        .view-x { height: 100%; left: 50%; top: 0; }
        .view-y { width: 100%; top: 50%; left: 0; }
        .view-z { width: 2px; height: 2px; background: #dc3545; left: 50%; top: 50%; }
        .view-target { position: absolute; width: 6px; height: 6px; background: #28a745; border-radius: 50%; transform: translate(-50%, -50%); }
        .target-audio { margin-top: 10px; }
        .audio-visualizer { width: 100%; height: 30px; background: #000; border-radius: 2px; }
        .visualizer-bar { width: 2px; height: 100%; background: #00ff00; margin-right: 1px; display: inline-block; }
        .target-recording { margin-top: 5px; }
        .record-btn { background: #dc3545; color: white; border: none; padding: 3px 6px; border-radius: 2px; cursor: pointer; font-size: 10px; }
        .record-active { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .target-export { margin-top: 10px; }
        .export-options { display: flex; gap: 5px; }
        .option-btn { flex: 1; padding: 3px; border: 1px solid #ced4da; background: white; border-radius: 2px; cursor: pointer; font-size: 10px; }
        .option-btn:hover { background: #f8f9fa; }
        .target-import { margin-top: 10px; }
        .import-options { display: flex; gap: 5px; }
        .import-btn { flex: 1; padding: 3px; border: 1px solid #ced4da; background: white; border-radius: 2px; cursor: pointer; font-size: 10px; }
        .import-btn:hover { background: #f8f9fa; }
        .target-backup { margin-top: 10px; }
        .backup-options { display: flex; gap: 5px; }
        .backup-btn { flex: 1; padding: 3px; border: 1px solid #ced4da; background: white; border-radius: 2px; cursor: pointer; font-size: 10px; }
        .backup-btn:hover { background: #f8f9fa; }
        .target-restore { margin-top: 10px; }
        .restore-options { display: flex; gap: 5px; }
        .restore-btn { flex: 1; padding: 3px; border: 1px solid #ced4da; background: white; border-radius: 2px; cursor: pointer; font-size: 10px; }
        .restore-btn:hover { background: #f8f9fa; }
        .target-sync { margin-top: 10px; }
        .sync-status { font-size: 12px; color: #6c757d; }
        .sync-online { color: #28a745; }
        .sync-offline { color: #dc3545; }
        .sync-btn { background: #17a2b8; color: white; border: none; padding: 3px 6px; border-radius: 2px; cursor: pointer; font-size: 10px; margin-top: 5px; }
        .target-log { margin-top: 10px; max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 5px; border-radius: 2px; }
        .log-entry { font-size: 10px; color: #6c757d; margin: 1px 0; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .target-settings { margin-top: 10px; }
        .settings-item { margin: 5px 0; }
        .settings-label { font-size: 12px; color: #495057; }
        .settings-input { width: 100%; padding: 2px; border: 1px solid #ced4da; border-radius: 2px; font-size: 12px; }
        .settings-btn { background: #6c757d; color: white; border: none; padding: 3px 6px; border-radius: 2px; cursor: pointer; font-size: 10px; margin-top: 5px; }
        .target-help { margin-top: 10px; }
        .help-link { font-size: 12px; color: #007bff; text-decoration: none; }
        .help-link:hover { text-decoration: underline; }
        .target-about { margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; }
        .about-text { font-size: 11px; color: #6c757d; }
        .version-info { font-size: 10px; color: #adb5bd; margin-top: 5px; }
        
        /* Все остальные стили остаются без изменений */
        .control-section { margin-bottom: 20px; }
        .input-group { margin-bottom: 10px; }
        .btn-group { display: flex; gap: 10px; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
        }
        /* ... и так далее все оригинальные стили ... */
    </style>
</head>
<body>
    <!-- Вся оригинальная HTML структура остается без изменений -->
    <div id="map"></div>
    
    <div class="info-panel">
        <h4>Інформація про систему</h4>
        <p>Статус: <span class="status-indicator status-online"></span> Онлайн</p>
        <p>Цілей: <span id="targetCount">0</span></p>
        <p class="timestamp" id="lastUpdate">Оновлено: --:--:--</p>
    </div>

    <div class="control-panel">
        <h4>Панель управління</h4>
        <div class="control-section">
            <label>ID цілі:</label>
            <input type="text" id="targetId" placeholder="Введіть ID цілі">
            
            <label>Широта:</label>
            <input type="number" id="targetLat" step="any" placeholder="Широта">
            
            <label>Довгота:</label>
            <input type="number" id="targetLng" step="any" placeholder="Довгота">
            
            <label>Курс (0-359°):</label>
            <input type="number" id="targetCourse" min="0" max="359" placeholder="Курс">
            
            <label>Швидкість (км/год):</label>
            <input type="number" id="targetSpeed" min="0" max="10000" placeholder="Швидкість">
            
            <label>Висота (м):</label>
            <input type="number" id="targetAltitude" min="0" max="20000" placeholder="Висота">
        </div>
        
        <div class="btn-group">
            <button onclick="addTarget()">Додати ціль</button>
            <button onclick="updateTarget()">Оновити ціль</button>
            <button onclick="clearTargets()">Очистити всі</button>
        </div>
    </div>

    <button class="toggle-sidebar" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <h4>Список цілей</h4>
        <div id="targetsList"></div>
    </div>

    <div class="alert-system" id="alertSystem">
        <div class="alert-content">
            <span id="alertMessage"></span>
            <button class="alert-close" onclick="hideAlert()">×</button>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.rotatedMarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
    // Глобальные переменные (остаются без изменений)
    let map;
    let targets = {};
    let markers = {};
    let updateInterval;
    let lastUpdateTime = 0;
    let isAdmin = false;
    let selectedTarget = null;
    let courseMarker;
    let courseLine;
    let socket;
    let simulationRunning = false;
    let simulationSpeed = 1.0;
    let markersCluster;
    let weatherData = {};
    let targetHistory = {};
    let userSettings = {};
    let systemStatus = 'online';
    let connectionRetries = 0;
    let maxConnectionRetries = 10;
    let backgroundSyncInterval;
    let lastBackgroundUpdate = 0;

    // Инициализация карты (остается без изменений)
    function initMap() {
        map = L.map('map').setView([48.0, 31.0], 7);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        markersCluster = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        map.addLayer(markersCluster);

        loadUserSettings();
        setupSocketConnection();
        loadTargets();
        startUpdateInterval();
        setupBackgroundSync();
        setupVisibilityHandler();
    }

    // Настройка WebSocket соединения (остается без изменений)
    function setupSocketConnection() {
        try {
            socket = io.connect(window.location.origin, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: Infinity,
                reconnectionDelay: 1000,
                reconnectionDelayMax: 5000,
                timeout: 20000
            });

            socket.on('connect', function() {
                console.log('Connected to server');
                connectionRetries = 0;
                systemStatus = 'online';
                updateSystemStatus();
                showNotification('Підключено до сервера', 'success');
            });

            socket.on('disconnect', function() {
                console.log('Disconnected from server');
                systemStatus = 'offline';
                updateSystemStatus();
                showNotification('Відключено від сервера', 'warning');
            });

            socket.on('reconnect_attempt', function(attemptNumber) {
                console.log('Reconnection attempt:', attemptNumber);
                connectionRetries = attemptNumber;
            });

            socket.on('reconnect_failed', function() {
                console.log('Reconnection failed');
                systemStatus = 'offline';
                updateSystemStatus();
                showNotification('Не вдалося підключитися до сервера', 'error');
            });

            // ОБНОВЛЕНИЕ: Немедленная синхронизация курса
            socket.on('course_updated', function(data) {
                console.log('Course updated received:', data);
                if (targets[data.targetId] && markers[data.targetId]) {
                    // Немедленное обновление курса для всех пользователей
                    targets[data.targetId].course = data.course;
                    markers[data.targetId].setRotationAngle(data.course);
                    
                    // Обновление popup content
                    markers[data.targetId].setPopupContent(`
                        <strong>Ціль ${data.targetId}</strong><br>
                        Курс: ${data.course}°<br>
                        Швидкість: ${targets[data.targetId].speed} км/год<br>
                        Висота: ${targets[data.targetId].altitude} м
                    `);
                    
                    // Обновление информации в sidebar
                    updateTargetsList();
                }
            });

            socket.on('targets_updated', function(data) {
                console.log('Targets updated received');
                targets = data.targets;
                updateAllMarkers();
                updateTargetsList();
                updateTargetCount();
                updateLastUpdateTime();
            });

            socket.on('target_added', function(data) {
                console.log('Target added:', data);
                targets[data.targetId] = data.target;
                updateMarker(data.targetId, data.target);
                updateTargetsList();
                updateTargetCount();
                showNotification(`Ціль ${data.targetId} додана`, 'success');
            });

            socket.on('target_updated', function(data) {
                console.log('Target updated:', data);
                if (targets[data.targetId]) {
                    targets[data.targetId] = data.target;
                    updateMarker(data.targetId, data.target);
                    updateTargetsList();
                    showNotification(`Ціль ${data.targetId} оновлена`, 'success');
                }
            });

            socket.on('target_deleted', function(data) {
                console.log('Target deleted:', data);
                if (markers[data.targetId]) {
                    map.removeLayer(markers[data.targetId]);
                    delete markers[data.targetId];
                    delete targets[data.targetId];
                }
                updateTargetsList();
                updateTargetCount();
                showNotification(`Ціль ${data.targetId} видалена`, 'warning');
            });

            socket.on('simulation_started', function() {
                simulationRunning = true;
                updateSimulationStatus();
                showNotification('Симуляцію запущено', 'success');
            });

            socket.on('simulation_stopped', function() {
                simulationRunning = false;
                updateSimulationStatus();
                showNotification('Симуляцію зупинено', 'warning');
            });

            socket.on('error', function(error) {
                console.error('Socket error:', error);
                showNotification('Помилка зв\'язку: ' + error.message, 'error');
            });

        } catch (error) {
            console.error('Error setting up socket connection:', error);
            systemStatus = 'offline';
            updateSystemStatus();
        }
    }

    // Загрузка целей (остается без изменений)
    function loadTargets() {
        fetch('/api/targets')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                targets = data;
                updateAllMarkers();
                updateTargetsList();
                updateTargetCount();
                updateLastUpdateTime();
                hideLoading();
            })
            .catch(error => {
                console.error('Error loading targets:', error);
                showNotification('Помилка завантаження цілей', 'error');
                hideLoading();
                
                // Пробуем загрузить из localStorage при ошибке
                loadTargetsFromStorage();
            });
    }

    // ОБНОВЛЕНИЕ: Настройка фоновой синхронизации
    function setupBackgroundSync() {
        // Интервал для фонового обновления (каждые 30 секунд)
        backgroundSyncInterval = setInterval(() => {
            if (document.hidden || !document.hasFocus()) {
                const currentTime = Date.now();
                const deltaTime = lastBackgroundUpdate > 0 ? (currentTime - lastBackgroundUpdate) / 1000 : 30;
                lastBackgroundUpdate = currentTime;

                // Двигаем цели в фоновом режиме
                moveTargetsInBackground(deltaTime);
                
                // Сохраняем состояние
                saveTargetsToStorage();
                
                // Пытаемся синхронизировать с сервером
                if (navigator.onLine && systemStatus === 'online') {
                    syncWithServer();
                }
            }
        }, 30000);
    }

    // ОБНОВЛЕНИЕ: Движение целей в фоновом режиме
    function moveTargetsInBackground(deltaTime) {
        for (const targetId in targets) {
            const target = targets[targetId];
            if (target.speed > 0) {
                // Конвертируем скорость из км/ч в м/с
                const speedMps = (target.speed * 1000) / 3600;
                
                // Вычисляем смещение
                const distance = speedMps * deltaTime * simulationSpeed;
                const courseRad = target.course * Math.PI / 180;
                
                // Новые координаты
                const earthRadius = 6371000;
                const latRad = target.lat * Math.PI / 180;
                
                const deltaLat = (distance * Math.cos(courseRad) / earthRadius) * 180 / Math.PI;
                const deltaLng = (distance * Math.sin(courseRad) / (earthRadius * Math.cos(latRad))) * 180 / Math.PI;
                
                target.lat += deltaLat;
                target.lng += deltaLng;
                
                // Обновляем время последнего движения
                target.lastMoveTime = Date.now();
                
                // Сохраняем в историю
                if (!targetHistory[targetId]) targetHistory[targetId] = [];
                targetHistory[targetId].push({
                    lat: target.lat,
                    lng: target.lng,
                    timestamp: Date.now()
                });
                
                // Ограничиваем размер истории
                if (targetHistory[targetId].length > 1000) {
                    targetHistory[targetId].shift();
                }
            }
        }
        
        // Обновляем маркеры если страница видима
        if (!document.hidden) {
            updateAllMarkers();
            updateTargetsList();
        }
    }

    // ОБНОВЛЕНИЕ: Обработчик изменения видимости страницы
    function setupVisibilityHandler() {
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Страница стала невидимой - увеличиваем интервал обновления
                clearInterval(updateInterval);
                updateInterval = setInterval(() => {
                    const currentTime = Date.now();
                    const deltaTime = lastUpdateTime > 0 ? (currentTime - lastUpdateTime) / 1000 : 1;
                    lastUpdateTime = currentTime;

                    moveTargets(deltaTime);
                    saveTargetsToStorage();
                }, 1000); // Обновляем раз в секунду в фоне
            } else {
                // Страница стала видимой - возвращаем нормальный интервал
                startUpdateInterval();
                // Загружаем актуальные данные
                loadTargets();
            }
        });

        // Обработчик ухода со страницы
        window.addEventListener('beforeunload', function() {
            // Сохраняем состояние перед закрытием
            saveTargetsToStorage();
            // Останавливаем фоновую синхронизацию
            clearInterval(backgroundSyncInterval);
        });
    }

    // Запуск интервала обновления (остается без изменений)
    function startUpdateInterval() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }

        updateInterval = setInterval(() => {
            const currentTime = Date.now();
            const deltaTime = lastUpdateTime > 0 ? (currentTime - lastUpdateTime) / 1000 : 0.1;
            lastUpdateTime = currentTime;

            moveTargets(deltaTime);
            updateAllMarkers();
            updateTargetsList();
            updateTargetCount();
            updateLastUpdateTime();
            
            // Автосохранение каждые 30 секунд
            if (currentTime % 30000 < 100) {
                saveTargetsToStorage();
            }
        }, 100);
    }

    // Движение целей (остается без изменений)
    function moveTargets(deltaTime) {
        for (const targetId in targets) {
            const target = targets[targetId];
            if (target.speed > 0) {
                const speedMps = (target.speed * 1000) / 3600;
                const distance = speedMps * deltaTime * simulationSpeed;
                const courseRad = target.course * Math.PI / 180;
                const earthRadius = 6371000;
                const latRad = target.lat * Math.PI / 180;
                
                const deltaLat = (distance * Math.cos(courseRad) / earthRadius) * 180 / Math.PI;
                const deltaLng = (distance * Math.sin(courseRad) / (earthRadius * Math.cos(latRad))) * 180 / Math.PI;
                
                target.lat += deltaLat;
                target.lng += deltaLng;
                target.lastMoveTime = Date.now();
                
                // Сохраняем историю
                if (!targetHistory[targetId]) targetHistory[targetId] = [];
                targetHistory[targetId].push({
                    lat: target.lat,
                    lng: target.lng,
                    timestamp: Date.now()
                });
                
                if (targetHistory[targetId].length > 1000) {
                    targetHistory[targetId].shift();
                }
            }
        }
    }
        // Создание/обновление маркера (остается без изменений)
function updateMarker(targetId, target) {
    if (!markers[targetId]) {
        const icon = L.divIcon({
            className: 'target-marker',
            html: `<div style="transform: rotate(${target.course}deg); color: ${getTargetColor(target)}; font-size: 24px;">➤</div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        markers[targetId] = L.marker([target.lat, target.lng], { 
            icon: icon,
            rotationAngle: target.course,
            zIndexOffset: 1000
        });

        markers[targetId].bindPopup(`
            <div class="target-popup">
                <strong>Ціль ${targetId}</strong><br>
                Курс: ${target.course}°<br>
                Швидкість: ${target.speed} км/год<br>
                Висота: ${target.altitude} м<br>
                <small>Оновлено: ${new Date().toLocaleTimeString()}</small>
            </div>
        `);

        markers[targetId].on('click', function(e) {
            if (isAdmin) {
                selectedTarget = targetId;
                showTargetControls(target);
            }
        });

        markersCluster.addLayer(markers[targetId]);
    } else {
        markers[targetId].setLatLng([target.lat, target.lng]);
        markers[targetId].setRotationAngle(target.course);
        markers[targetId].setPopupContent(`
            <div class="target-popup">
                <strong>Ціль ${targetId}</strong><br>
                Курс: ${target.course}°<br>
                Швидкість: ${target.speed} км/год<br>
                Висота: ${target.altitude} м<br>
                <small>Оновлено: ${new Date().toLocaleTimeString()}</small>
            </div>
        `);
        
        // Обновляем иконку
        const icon = L.divIcon({
            className: 'target-marker',
            html: `<div style="transform: rotate(${target.course}deg); color: ${getTargetColor(target)}; font-size: 24px;">➤</div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        markers[targetId].setIcon(icon);
    }
}

// Обновление всех маркеров (остается без изменений)
function updateAllMarkers() {
    for (const targetId in targets) {
        updateMarker(targetId, targets[targetId]);
    }
}

// ОБНОВЛЕНИЕ: Функции для работы с курсом
function updateTargetCourse(targetId, course) {
    if (targets[targetId]) {
        // Локальное обновление
        targets[targetId].course = course;
        
        if (markers[targetId]) {
            markers[targetId].setRotationAngle(course);
            
            // Обновление иконки
            const icon = L.divIcon({
                className: 'target-marker',
                html: `<div style="transform: rotate(${course}deg); color: ${getTargetColor(targets[targetId])}; font-size: 24px;">➤</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            markers[targetId].setIcon(icon);
            
            // Обновление popup
            markers[targetId].setPopupContent(`
                <div class="target-popup">
                    <strong>Ціль ${targetId}</strong><br>
                    Курс: ${course}°<br>
                    Швидкість: ${targets[targetId].speed} км/год<br>
                    Висота: ${targets[targetId].altitude} м<br>
                    <small>Оновлено: ${new Date().toLocaleTimeString()}</small>
                </div>
            `);
        }
        
        // Отправка на сервер
        if (socket && socket.connected) {
            socket.emit('update_course', {
                targetId: targetId,
                course: course
            });
        }
        
        // Обновление списка целей
        updateTargetsList();
    }
}

// ОБНОВЛЕНИЕ: Добавление цели с проверкой скорости
function addTarget() {
    const targetId = document.getElementById('targetId').value.trim();
    const lat = parseFloat(document.getElementById('targetLat').value);
    const lng = parseFloat(document.getElementById('targetLng').value);
    let course = parseInt(document.getElementById('targetCourse').value);
    let speed = parseInt(document.getElementById('targetSpeed').value);
    const altitude = parseInt(document.getElementById('targetAltitude').value);

    // Валидация
    if (!targetId || isNaN(lat) || isNaN(lng)) {
        showNotification('Будь ласка, заповніть обов\'язкові поля', 'error');
        return;
    }

    if (targets[targetId]) {
        showNotification('Ціль з таким ID вже існує', 'error');
        return;
    }

    // ОБНОВЛЕНИЕ: Проверка максимальной скорости (10000 вместо 5000)
    if (speed > 10000) {
        showNotification('Максимальна швидкість: 10000 км/год', 'error');
        speed = 10000;
        document.getElementById('targetSpeed').value = 10000;
    }

    if (speed < 0) {
        showNotification('Швидкість не може бути від\'ємною', 'error');
        speed = 0;
        document.getElementById('targetSpeed').value = 0;
    }

    if (course < 0) course = 0;
    if (course > 359) course = 359;

    const target = {
        lat: lat,
        lng: lng,
        course: course,
        speed: speed,
        altitude: altitude,
        createdAt: Date.now(),
        lastUpdate: Date.now(),
        lastMoveTime: Date.now()
    };

    // Локальное добавление
    targets[targetId] = target;
    updateMarker(targetId, target);
    updateTargetsList();
    updateTargetCount();

    // Отправка на сервер
    if (socket && socket.connected) {
        socket.emit('add_target', {
            targetId: targetId,
            target: target
        });
    }

    // Очистка формы
    clearForm();
    showNotification(`Ціль ${targetId} додана`, 'success');
}

// ОБНОВЛЕНИЕ: Обновление цели с проверкой скорости
function updateTarget() {
    if (!selectedTarget) {
        showNotification('Будь ласка, виберіть ціль для оновлення', 'error');
        return;
    }

    const lat = parseFloat(document.getElementById('targetLat').value);
    const lng = parseFloat(document.getElementById('targetLng').value);
    let course = parseInt(document.getElementById('targetCourse').value);
    let speed = parseInt(document.getElementById('targetSpeed').value);
    const altitude = parseInt(document.getElementById('targetAltitude').value);

    if (isNaN(lat) || isNaN(lng)) {
        showNotification('Будь ласка, введіть коректні координати', 'error');
        return;
    }

    // ОБНОВЛЕНИЕ: Проверка максимальной скорости (10000 вместо 5000)
    if (speed > 10000) {
        showNotification('Максимальна швидкість: 10000 км/год', 'error');
        speed = 10000;
        document.getElementById('targetSpeed').value = 10000;
    }

    if (speed < 0) {
        showNotification('Швидкість не може бути від\'ємною', 'error');
        speed = 0;
        document.getElementById('targetSpeed').value = 0;
    }

    if (course < 0) course = 0;
    if (course > 359) course = 359;

    const target = {
        lat: lat,
        lng: lng,
        course: course,
        speed: speed,
        altitude: altitude,
        lastUpdate: Date.now(),
        lastMoveTime: targets[selectedTarget].lastMoveTime || Date.now(),
        createdAt: targets[selectedTarget].createdAt || Date.now()
    };

    // Локальное обновление
    targets[selectedTarget] = target;
    updateMarker(selectedTarget, target);
    updateTargetsList();

    // ОБНОВЛЕНИЕ: Немедленная синхронизация курса
    if (socket && socket.connected) {
        socket.emit('update_target', {
            targetId: selectedTarget,
            target: target
        });
        
        // Отдельно отправляем обновление курса для мгновенной синхронизации
        socket.emit('update_course', {
            targetId: selectedTarget,
            course: course
        });
    }

    showNotification(`Ціль ${selectedTarget} оновлена`, 'success');
}

// ОБНОВЛЕНИЕ: Сохранение целей в localStorage
function saveTargetsToStorage() {
    try {
        const data = {
            targets: targets,
            targetHistory: targetHistory,
            timestamp: Date.now()
        };
        localStorage.setItem('airTargetsData', JSON.stringify(data));
    } catch (error) {
        console.error('Error saving to localStorage:', error);
    }
}

// ОБНОВЛЕНИЕ: Загрузка целей из localStorage
function loadTargetsFromStorage() {
    try {
        const savedData = localStorage.getItem('airTargetsData');
        if (savedData) {
            const data = JSON.parse(savedData);
            targets = data.targets || {};
            targetHistory = data.targetHistory || {};
            
            updateAllMarkers();
            updateTargetsList();
            updateTargetCount();
            updateLastUpdateTime();
            
            showNotification('Дані завантажено з локального сховища', 'warning');
        }
    } catch (error) {
        console.error('Error loading from localStorage:', error);
    }
}

// ОБНОВЛЕНИЕ: Синхронизация с сервером
function syncWithServer() {
    if (socket && socket.connected) {
        socket.emit('sync_targets', {
            targets: targets,
            timestamp: Date.now()
        });
    }
}

// Остальные функции остаются без изменений
function clearTargets() {
    if (confirm('Ви впевнені, що хочете видалити всі цілі?')) {
        for (const targetId in markers) {
            map.removeLayer(markers[targetId]);
        }
        markers = {};
        targets = {};
        targetHistory = {};
        
        markersCluster.clearLayers();
        updateTargetsList();
        updateTargetCount();
        
        if (socket && socket.connected) {
            socket.emit('clear_targets');
        }
        
        // Очищаем localStorage
        localStorage.removeItem('airTargetsData');
        
        showNotification('Всі цілі видалені', 'warning');
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

function updateTargetsList() {
    const targetsList = document.getElementById('targetsList');
    let html = '';
    
    for (const targetId in targets) {
        const target = targets[targetId];
        html += `
            <div class="target-card" onclick="selectTarget('${targetId}')">
                <h5>Ціль ${targetId}</h5>
                <div class="target-properties">
                    <div class="property-item">
                        <div class="property-label">Курс</div>
                        <div class="property-value">${target.course}°</div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">Швидкість</div>
                        <div class="property-value">${target.speed} км/год</div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">Висота</div>
                        <div class="property-value">${target.altitude} м</div>
                    </div>
                </div>
                <div class="target-actions">
                    <button class="action-btn action-track" onclick="trackTarget('${targetId}', event)">Стежити</button>
                    <button class="action-btn action-lock" onclick="lockTarget('${targetId}', event)">Зафіксувати</button>
                    <button class="action-btn action-delete" onclick="deleteTarget('${targetId}', event)">Видалити</button>
                </div>
            </div>
        `;
    }
    
    targetsList.innerHTML = html || '<p>Немає активних цілей</p>';
}

function selectTarget(targetId) {
    if (targets[targetId]) {
        selectedTarget = targetId;
        const target = targets[targetId];
        
        // Заполняем форму данными цели
        document.getElementById('targetId').value = targetId;
        document.getElementById('targetLat').value = target.lat;
        document.getElementById('targetLng').value = target.lng;
        document.getElementById('targetCourse').value = target.course;
        document.getElementById('targetSpeed').value = target.speed;
        document.getElementById('targetAltitude').value = target.altitude;
        
        // Центрируем карту на цели
        map.setView([target.lat, target.lng], 10);
        
        // Открываем popup
        if (markers[targetId]) {
            markers[targetId].openPopup();
        }
    }
}

function deleteTarget(targetId, event) {
    if (event) event.stopPropagation();
    
    if (confirm(`Видалити ціль ${targetId}?`)) {
        if (markers[targetId]) {
            map.removeLayer(markers[targetId]);
            delete markers[targetId];
        }
        delete targets[targetId];
        delete targetHistory[targetId];
        
        markersCluster.removeLayer(markers[targetId]);
        updateTargetsList();
        updateTargetCount();
        
        if (socket && socket.connected) {
            socket.emit('delete_target', { targetId: targetId });
        }
        
        // Обновляем localStorage
        saveTargetsToStorage();
        
        showNotification(`Ціль ${targetId} видалена`, 'warning');
    }
            }
                function trackTarget(targetId, event) {
            if (event) event.stopPropagation();
            
            if (targets[targetId]) {
                const target = targets[targetId];
                map.setView([target.lat, target.lng], 12);
                
                if (markers[targetId]) {
                    markers[targetId].openPopup();
                }
                
                showNotification(`Відстежуємо ціль ${targetId}`, 'success');
            }
        }

        function lockTarget(targetId, event) {
            if (event) event.stopPropagation();
            
            if (targets[targetId]) {
                selectedTarget = targetId;
                const target = targets[targetId];
                
                // Заполняем форму
                document.getElementById('targetId').value = targetId;
                document.getElementById('targetLat').value = target.lat;
                document.getElementById('targetLng').value = target.lng;
                document.getElementById('targetCourse').value = target.course;
                document.getElementById('targetSpeed').value = target.speed;
                document.getElementById('targetAltitude').value = target.altitude;
                
                showNotification(`Ціль ${targetId} зафіксована для редагування`, 'success');
            }
        }

        function clearForm() {
            document.getElementById('targetId').value = '';
            document.getElementById('targetLat').value = '';
            document.getElementById('targetLng').value = '';
            document.getElementById('targetCourse').value = '';
            document.getElementById('targetSpeed').value = '';
            document.getElementById('targetAltitude').value = '';
            selectedTarget = null;
        }

        function updateTargetCount() {
            document.getElementById('targetCount').textContent = Object.keys(targets).length;
        }

        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = 
                `Оновлено: ${new Date().toLocaleTimeString()}`;
        }

        function updateSystemStatus() {
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('.info-panel p:nth-child(2)');
            
            if (systemStatus === 'online') {
                statusIndicator.className = 'status-indicator status-online';
                statusText.innerHTML = 'Статус: <span class="status-indicator status-online"></span> Онлайн';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.innerHTML = 'Статус: <span class="status-indicator status-offline"></span> Офлайн';
            }
        }

        function updateSimulationStatus() {
            const statusElement = document.getElementById('simulationStatus');
            if (statusElement) {
                if (simulationRunning) {
                    statusElement.className = 'simulation-status status-running';
                    statusElement.textContent = 'Симуляція: Активна';
                } else {
                    statusElement.className = 'simulation-status status-stopped';
                    statusElement.textContent = 'Симуляція: Зупинена';
                }
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('alertSystem');
            const messageElement = document.getElementById('alertMessage');
            
            messageElement.textContent = message;
            notification.className = `alert-system ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function hideAlert() {
            document.getElementById('alertSystem').style.display = 'none';
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function getTargetColor(target) {
            if (target.speed > 8000) return '#dc3545'; // Красный для высоких скоростей
            if (target.speed > 4000) return '#ffc107'; // Желтый для средних скоростей
            if (target.altitude > 10000) return '#6f42c1'; // Фиолетовый для больших высот
            return '#007bff'; // Синий по умолчанию
        }

        function loadUserSettings() {
            try {
                const savedSettings = localStorage.getItem('userSettings');
                if (savedSettings) {
                    userSettings = JSON.parse(savedSettings);
                    
                    // Применяем настройки
                    if (userSettings.mapView) {
                        map.setView(userSettings.mapView.center, userSettings.mapView.zoom);
                    }
                    
                    if (userSettings.simulationSpeed) {
                        simulationSpeed = userSettings.simulationSpeed;
                        document.getElementById('simulationSpeed').value = simulationSpeed;
                    }
                }
            } catch (error) {
                console.error('Error loading user settings:', error);
            }
        }

        function saveUserSettings() {
            try {
                userSettings.mapView = {
                    center: map.getCenter(),
                    zoom: map.getZoom()
                };
                
                userSettings.simulationSpeed = simulationSpeed;
                
                localStorage.setItem('userSettings', JSON.stringify(userSettings));
            } catch (error) {
                console.error('Error saving user settings:', error);
            }
        }

        // ОБНОВЛЕНИЕ: Глобальные функции для доступа из консоли
        window.getTarget = function(targetId) {
            return targets[targetId];
        };

        window.getAllTargets = function() {
            return targets;
        };

        window.setTargetCourse = function(targetId, course) {
            updateTargetCourse(targetId, course);
        };

        window.setTargetSpeed = function(targetId, speed) {
            if (targets[targetId]) {
                // ОБНОВЛЕНИЕ: Проверка максимальной скорости (10000 вместо 5000)
                if (speed > 10000) {
                    console.warn('Максимальна швидкість: 10000 км/год');
                    speed = 10000;
                }
                
                targets[targetId].speed = speed;
                updateMarker(targetId, targets[targetId]);
                updateTargetsList();
                
                if (socket && socket.connected) {
                    socket.emit('update_target', {
                        targetId: targetId,
                        target: targets[targetId]
                    });
                }
            }
        };

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            
            // Проверка прав администратора
            const urlParams = new URLSearchParams(window.location.search);
            isAdmin = urlParams.get('admin') === 'true';
            
            if (isAdmin) {
                const adminBadge = document.createElement('div');
                adminBadge.className = 'admin-badge';
                adminBadge.textContent = 'АДМІНІСТРАТОР';
                document.body.appendChild(adminBadge);
                
                showNotification('Режим адміністратора активовано', 'success');
            }
            
            // Загрузка начальных данных
            showLoading();
            setTimeout(() => {
                if (Object.keys(targets).length === 0) {
                    hideLoading();
                }
            }, 3000);
            
            // Автосохранение при закрытии
            window.addEventListener('beforeunload', function() {
                saveTargetsToStorage();
                saveUserSettings();
            });
        });

        // Service Worker для фоновой работы
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
                console.log('ServiceWorker registered with scope:', registration.scope);
            }).catch(function(error) {
                console.log('ServiceWorker registration failed:', error);
            });
        }
    </script>
</body>
</html>
        
