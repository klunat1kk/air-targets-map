<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта повітряних цілей</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* ... (все существующие стили остаются без изменений) ... */
    </style>
</head>
<body>
    <!-- ... (все существующая HTML структура остается без изменений) ... -->

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Глобальные переменные
        let map;
        let markers = {};
        let animationPaused = false;
        let courseMode = false;
        let addMode = false;
        let trailsVisible = true;
        let selectedTargetId = null;
        let currentMapView = 'street';
        let baseLayers = {};
        let targets = [];
        let animationInterval;
        let targetTrails = {};
        let targetHistory = {};
        let clickMarker = null;
        let lastFrameTime = performance.now();
        let hiddenTargets = new Set();
        let socket = io();

        // Инициализация карты
        async function initMap() {
            console.log("Инициализация карты...");

            map = L.map('map').setView([50.4501, 30.5234], 6);

            baseLayers.street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });

            baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 19
            });

            baseLayers.street.addTo(map);

            // Инициализация поиска
            initSearch();

            // Обработчик кликов по карте
            map.on('click', function(e) {
                if (addMode) {
                    handleAddClick(e);
                } else if (courseMode && selectedTargetId !== null) {
                    updateTargetCourse(e);
                }
            });

            // Обработчик перемещения карты
            map.on('moveend', updateVisibleTargets);

            // Загрузка целей с сервера
            await loadTargets();
            startAnimation();

            // Настройка socket.io обработчиков
            setupSocketHandlers();
        }

        // Настройка обработчиков socket.io
        function setupSocketHandlers() {
            // Обновление счетчика пользователей
            socket.on('usersCount', (count) => {
                // Можно добавить отображение счетчика если нужно
                console.log('Онлайн пользователей:', count);
            });

            // Новая цель добавлена
            socket.on('targetAdded', (target) => {
                if (!targets.find(t => t.id === target.id)) {
                    targets.push(target);
                    targetHistory[target.id] = [[target.lat, target.lng]];
                    updateMapMarkers();
                    updateTargetsList();
                }
            });

            // Цель обновлена
            socket.on('targetUpdated', (target) => {
                const index = targets.findIndex(t => t.id === target.id);
                if (index !== -1) {
                    targets[index] = {...targets[index], ...target};
                    if (markers[target.id]) {
                        const newIcon = createTriangleIcon(target.type, target.course);
                        markers[target.id].setIcon(newIcon);
                    }
                    updateTargetsList();
                }
            });

            // Цель удалена
            socket.on('targetDeleted', (targetId) => {
                const index = targets.findIndex(t => t.id === targetId);
                if (index !== -1) {
                    targets.splice(index, 1);
                    if (targetTrails[targetId]) {
                        map.removeLayer(targetTrails[targetId]);
                        delete targetTrails[targetId];
                    }
                    if (targetHistory[targetId]) {
                        delete targetHistory[targetId];
                    }
                    updateMapMarkers();
                    updateTargetsList();
                }
            });

            // Цель перемещена другим пользователем
            socket.on('targetMoved', (data) => {
                const target = targets.find(t => t.id === data.id);
                if (target) {
                    target.lat = data.lat;
                    target.lng = data.lng;

                    if (!targetHistory[target.id]) targetHistory[target.id] = [];
                    targetHistory[target.id].push([data.lat, data.lng]);

                    if (markers[target.id] && map.hasLayer(markers[target.id])) {
                        markers[target.id].setLatLng([data.lat, data.lng]);
                    }
                    updateTargetsList();
                }
            });

            // Курс цели изменен другим пользователем
            socket.on('targetCourseUpdated', (data) => {
                const target = targets.find(t => t.id === data.id);
                if (target) {
                    target.course = data.course;
                    if (markers[target.id]) {
                        const newIcon = createTriangleIcon(target.type, data.course);
                        markers[target.id].setIcon(newIcon);
                    }
                    updateTargetsList();
                }
            });
        }

        // Загрузка целей с сервера
        async function loadTargets() {
            try {
                const response = await fetch('/api/targets');
                targets = await response.json();

                // Инициализируем историю для каждой цели
                targets.forEach(target => {
                    targetHistory[target.id] = [[target.lat, target.lng]];
                });

                updateTargetsList();
                updateMapMarkers();
            } catch (error) {
                console.error('Ошибка загрузки целей:', error);
                // Fallback к локальным данным
                targets = [
                    {id: 1, name: "F-16", type: "винищувач", speed: 800, course: 45, lat: 50.45, lng: 30.52},
                    {id: 2, name: "Shahed-136", type: "дрон", speed: 180, course: 120, lat: 49.0, lng: 31.0}
                ];
                targets.forEach(target => {
                    targetHistory[target.id] = [[target.lat, target.lng]];
                });
                updateTargetsList();
                updateMapMarkers();
            }
        }

        // Сохранение цели на сервер
        async function saveTarget() {
            const id = document.getElementById('targetId').value;
            const name = document.getElementById('targetName').value;
            const speed = parseFloat(document.getElementById('targetSpeed').value);
            const course = parseFloat(document.getElementById('targetCourse').value);
            const type = document.getElementById('targetType').value;

            try {
                if (id) {
                    // Редактирование существующей цели
                    const response = await fetch(`/api/targets/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({name, speed, course, type})
                    });

                    if (response.ok) {
                        const target = targets.find(t => t.id === parseInt(id));
                        if (target) {
                            target.name = name;
                            target.speed = speed;
                            target.course = course;
                            target.type = type;
                        }
                    }
                } else {
                    // Добавление новой цели
                    let lat, lng;
                    if (window.newTargetLatLng) {
                        lat = window.newTargetLatLng.lat;
                        lng = window.newTargetLatLng.lng;
                    } else {
                        const center = map.getCenter();
                        lat = center.lat + (Math.random() - 0.5);
                        lng = center.lng + (Math.random() - 0.5);
                    }

                    const response = await fetch('/api/targets', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({name, type, speed, course, lat, lng})
                    });

                    if (response.ok) {
                        const newTarget = await response.json();
                        targets.push(newTarget);
                        targetHistory[newTarget.id] = [[lat, lng]];
                    }
                }

                updateMapMarkers();
                updateTargetsList();
                hideTargetForm();
            } catch (error) {
                console.error('Ошибка сохранения цели:', error);
                alert('Ошибка сохранения цели. Проверьте подключение к серверу.');
            }
        }

        // Удаление цели с сервера
        async function deleteTarget() {
            const id = document.getElementById('targetId').value;
            if (!id) return;

            if (confirm('Ви впевнені, що хочете видалити цю ціль?')) {
                try {
                    const response = await fetch(`/api/targets/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        const index = targets.findIndex(t => t.id === parseInt(id));
                        if (index !== -1) {
                            targets.splice(index, 1);
                            if (targetTrails[id]) {
                                map.removeLayer(targetTrails[id]);
                                delete targetTrails[id];
                            }
                            if (targetHistory[id]) {
                                delete targetHistory[id];
                            }
                            updateMapMarkers();
                            updateTargetsList();
                        }
                    }
                } catch (error) {
                    console.error('Ошибка удаления цели:', error);
                    alert('Ошибка удаления цели. Проверьте подключение к серверу.');
                }
            }
            hideTargetForm();
        }

        // В moveTargets добавляем отправку обновлений позиций на сервер
        function moveTargets() {
            if (animationPaused) return;

            const now = performance.now();
            const deltaTime = (now - lastFrameTime) / 1000;
            lastFrameTime = now;
            const bounds = map.getBounds();

            targets.forEach(target => {
                if (target.speed > 0) {
                    // ... (существующая логика расчета движения) ...

                    // После обновления позиции отправляем на сервер
                    if (target.lat !== oldLat || target.lng !== oldLng) {
                        socket.emit('targetMove', {
                            id: target.id,
                            lat: target.lat,
                            lng: target.lng
                        });
                    }
                }
            });

            updateTargetsList();
        }

        // В updateTargetCourse добавляем отправку обновления курса
        function updateTargetCourse(e) {
            if (!selectedTargetId) return;

            const target = targets.find(t => t.id === selectedTargetId);
            if (!target) return;

            const dx = e.latlng.lng - target.lng;
            const dy = e.latlng.lat - target.lat;
            let newCourse = (Math.atan2(dy, dx) * 180 / Math.PI + 90 + 360) % 360;

            target.course = newCourse;

            // Отправляем обновление курса на сервер
            socket.emit('targetCourse', {
                id: target.id,
                course: newCourse
            });

            if (markers[target.id]) {
                const newIcon = createTriangleIcon(target.type, newCourse);
                markers[target.id].setIcon(newIcon);
            }

            alert(`Курс змінено на: ${Math.round(newCourse)}°`);
            courseMode = false;
            selectedTargetId = null;
        }

        // ... (остальные функции остаются без изменений) ...
    </script>
</body>
</html>